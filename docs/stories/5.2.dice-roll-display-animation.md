# Story 5.2: Dice Roll Display & Animation

## Status
Draft

## Story
**As a** Player,
**I want** to see dice rolls displayed in chat with visual animations and clear results,
**so that** I can easily understand roll outcomes and share excitement with the table.

## Acceptance Criteria
1. Dice rolls appear in chat as special message cards (not plain text)
2. Roll cards show: character name, notation, individual dice, total, reason
3. Critical hits (nat 20) display with gold/yellow highlight
4. Critical misses (nat 1) display with red highlight
5. Advantage/disadvantage shows both rolls with strikethrough on unused
6. Dice icons display for each die type (d4, d6, d8, d10, d12, d20, d100)
7. Roll animation plays when dice are rolled (0.3s spin effect)
8. Quick roll buttons in chat input: d20, d20 adv, d20 dis, custom

## Tasks / Subtasks

- [ ] Create DiceRollCard component (AC: 1, 2)
  - [ ] Card shows character avatar + name
  - [ ] Display notation prominently (e.g., "3d6+5")
  - [ ] Show individual dice values as badges
  - [ ] Display total in large text
  - [ ] Show reason (if provided): "for Attack roll"
  - [ ] Timestamp in bottom-right

- [ ] Style critical hits (AC: 3)
  - [ ] Check if roll type is 'critical' and total is 20
  - [ ] Apply gold/yellow gradient background
  - [ ] Add sparkle animation (optional)
  - [ ] Show "CRITICAL HIT!" badge
  - [ ] Larger font for total

- [ ] Style critical misses (AC: 4)
  - [ ] Check if roll type is 'critical' and total is 1
  - [ ] Apply red border and background tint
  - [ ] Show "CRITICAL MISS!" badge
  - [ ] Optional: sad emoji ðŸ˜ž

- [ ] Display advantage/disadvantage (AC: 5)
  - [ ] Show both die results
  - [ ] Strikethrough unused roll
  - [ ] Example: "[~~12~~, **18**] = 18 (advantage)"
  - [ ] Highlight selected roll in green-neon

- [ ] Create dice icon components (AC: 6)
  - [ ] SVG icons for d4, d6, d8, d10, d12, d20, d100
  - [ ] Show dice icon next to value
  - [ ] Color-code by dice type (optional)
  - [ ] Example: [d6] 4, [d6] 5, [d6] 3

- [ ] Implement roll animation (AC: 7)
  - [ ] Trigger animation on `roll:new` Socket.io event
  - [ ] Spin effect for dice icons (0.3s)
  - [ ] Fade-in for total value (stagger 0.5s)
  - [ ] Pulse effect for critical hits
  - [ ] Use Framer Motion or CSS keyframes

- [ ] Add quick roll buttons (AC: 8)
  - [ ] Button group above chat input
  - [ ] [d20] [d20 Adv] [d20 Dis] [Custom...]
  - [ ] d20: rolls 1d20 with no modifier
  - [ ] d20 Adv: rolls with advantage
  - [ ] d20 Dis: rolls with disadvantage
  - [ ] Custom: opens modal for notation input

- [ ] Create custom roll modal (AC: 8)
  - [ ] Input for notation (e.g., "3d6+5")
  - [ ] Optional input for reason
  - [ ] Checkbox for advantage/disadvantage
  - [ ] Preview parsed notation
  - [ ] "Roll" button

- [ ] Integrate with chat (AC: 1)
  - [ ] Listen to `roll:new` Socket.io event
  - [ ] Append DiceRollCard to message list
  - [ ] Sort rolls chronologically with text messages
  - [ ] Auto-scroll to bottom after roll

- [ ] Add roll sound effects (optional)
  - [ ] Play dice rolling sound on roll
  - [ ] Different sound for critical hit/miss
  - [ ] User preference to enable/disable sounds

## Dev Notes

### Dice Roll Card Component
**[Source: Front-End Spec Section 6.5 - Dice Roll Cards]**

```typescript
interface DiceRollCardProps {
  roll: {
    id: string;
    notation: string;
    rolls: number[];
    total: number;
    modifier: number;
    type: 'normal' | 'advantage' | 'disadvantage' | 'critical';
    reason?: string;
    user: {
      username: string;
      avatar?: string;
    };
    character?: {
      name: string;
    };
    createdAt: Date;
  };
}

export function DiceRollCard({ roll }: DiceRollCardProps) {
  const isCriticalHit = roll.type === 'critical' && roll.total === 20;
  const isCriticalMiss = roll.type === 'critical' && roll.total === 1;

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.3 }}
      className={`p-4 rounded-lg border ${
        isCriticalHit
          ? 'border-yellow-500 bg-gradient-to-br from-yellow-500/20 to-transparent'
          : isCriticalMiss
          ? 'border-red-500 bg-red-500/10'
          : 'border-gray-800 bg-gray-900'
      }`}
    >
      {/* Header */}
      <div className="flex items-center gap-3 mb-3">
        <Avatar className="h-8 w-8">
          <AvatarImage src={roll.user.avatar} />
          <AvatarFallback>{roll.user.username[0]}</AvatarFallback>
        </Avatar>

        <div className="flex-1">
          <p className="font-medium">
            {roll.character?.name || roll.user.username}
          </p>
          <p className="text-xs text-gray-400">
            rolled {roll.notation}
            {roll.reason && ` for ${roll.reason}`}
          </p>
        </div>

        <span className="text-xs text-gray-400">
          {formatTimestamp(roll.createdAt)}
        </span>
      </div>

      {/* Dice results */}
      <div className="flex items-center gap-3 mb-2">
        <div className="flex flex-wrap gap-2">
          {roll.type === 'advantage' || roll.type === 'disadvantage' ? (
            <>
              {roll.rolls.map((value, idx) => {
                const isUsed =
                  (roll.type === 'advantage' && value === Math.max(...roll.rolls)) ||
                  (roll.type === 'disadvantage' && value === Math.min(...roll.rolls));

                return (
                  <DiceValue
                    key={idx}
                    value={value}
                    type="d20"
                    isUsed={isUsed}
                    animate
                  />
                );
              })}
            </>
          ) : (
            roll.rolls.map((value, idx) => (
              <DiceValue
                key={idx}
                value={value}
                type={`d${getDiceSides(roll.notation)}`}
                animate
              />
            ))
          )}
        </div>

        <div className="flex items-center gap-2">
          {roll.modifier !== 0 && (
            <span className="text-sm text-gray-400">
              {roll.modifier > 0 ? '+' : ''}{roll.modifier}
            </span>
          )}
          <span className="text-2xl font-bold">=</span>
        </div>
      </div>

      {/* Total */}
      <motion.div
        initial={{ scale: 0.8 }}
        animate={{ scale: 1 }}
        transition={{ delay: 0.5, type: 'spring' }}
        className="flex items-center justify-between"
      >
        <div className={`text-4xl font-bold ${
          isCriticalHit
            ? 'text-yellow-500'
            : isCriticalMiss
            ? 'text-red-500'
            : 'text-green-neon'
        }`}>
          {roll.total}
        </div>

        {isCriticalHit && (
          <Badge className="bg-yellow-500 text-black font-bold">
            CRITICAL HIT! âš¡
          </Badge>
        )}

        {isCriticalMiss && (
          <Badge className="bg-red-500 text-white font-bold">
            CRITICAL MISS ðŸ˜ž
          </Badge>
        )}

        {roll.type === 'advantage' && (
          <Badge variant="outline" className="border-green-neon text-green-neon">
            Advantage
          </Badge>
        )}

        {roll.type === 'disadvantage' && (
          <Badge variant="outline" className="border-red text-red">
            Disadvantage
          </Badge>
        )}
      </motion.div>
    </motion.div>
  );
}
```

### Dice Value Component with Animation
```typescript
interface DiceValueProps {
  value: number;
  type: 'd4' | 'd6' | 'd8' | 'd10' | 'd12' | 'd20' | 'd100';
  isUsed?: boolean;
  animate?: boolean;
}

function DiceValue({ value, type, isUsed = true, animate = false }: DiceValueProps) {
  return (
    <motion.div
      initial={animate ? { rotate: 0 } : false}
      animate={animate ? { rotate: [0, 360, 0] } : false}
      transition={{ duration: 0.3 }}
      className={`flex items-center gap-1 px-3 py-2 rounded ${
        isUsed
          ? 'bg-green-neon/20 border border-green-neon/50'
          : 'bg-gray-800 border border-gray-700 line-through opacity-50'
      }`}
    >
      <DiceIcon type={type} className="w-4 h-4" />
      <span className={`font-mono font-bold ${isUsed ? 'text-green-neon' : 'text-gray-400'}`}>
        {value}
      </span>
    </motion.div>
  );
}
```

### Dice Icon Component
```typescript
interface DiceIconProps {
  type: 'd4' | 'd6' | 'd8' | 'd10' | 'd12' | 'd20' | 'd100';
  className?: string;
}

function DiceIcon({ type, className }: DiceIconProps) {
  // Simple SVG icons for each dice type
  const icons = {
    d4: (
      <svg viewBox="0 0 24 24" className={className} fill="currentColor">
        <path d="M12 2L2 20h20L12 2z" />
      </svg>
    ),
    d6: (
      <svg viewBox="0 0 24 24" className={className} fill="currentColor">
        <rect x="4" y="4" width="16" height="16" rx="2" />
      </svg>
    ),
    d8: (
      <svg viewBox="0 0 24 24" className={className} fill="currentColor">
        <path d="M12 2L2 12l10 10 10-10L12 2z" />
      </svg>
    ),
    d10: (
      <svg viewBox="0 0 24 24" className={className} fill="currentColor">
        <path d="M12 2L3 8v8l9 6 9-6V8l-9-6z" />
      </svg>
    ),
    d12: (
      <svg viewBox="0 0 24 24" className={className} fill="currentColor">
        <path d="M12 2L4 7v10l8 5 8-5V7l-8-5z" />
      </svg>
    ),
    d20: (
      <svg viewBox="0 0 24 24" className={className} fill="currentColor">
        <path d="M12 2L2 7v10l10 5 10-5V7L12 2z" />
      </svg>
    ),
    d100: (
      <svg viewBox="0 0 24 24" className={className} fill="currentColor">
        <path d="M12 2L4 6v12l8 4 8-4V6l-8-4z" />
        <text x="12" y="14" fontSize="8" textAnchor="middle" fill="currentColor">%</text>
      </svg>
    ),
  };

  return icons[type] || icons.d20;
}
```

### Quick Roll Buttons
```typescript
function QuickRollButtons({ tableId }: { tableId: string }) {
  const [showCustomModal, setShowCustomModal] = useState(false);

  const handleQuickRoll = async (notation: string, options?: { advantage?: boolean; disadvantage?: boolean }) => {
    try {
      await rollDice(tableId, notation, options);
      toast.success('Dice rolled!');
    } catch (error) {
      toast.error(error.message);
    }
  };

  return (
    <div className="flex gap-2 p-2 border-t border-gray-800">
      <Button
        variant="outline"
        size="sm"
        onClick={() => handleQuickRoll('1d20')}
      >
        <DiceIcon type="d20" className="w-4 h-4 mr-1" />
        d20
      </Button>

      <Button
        variant="outline"
        size="sm"
        className="border-green-neon text-green-neon"
        onClick={() => handleQuickRoll('1d20', { advantage: true })}
      >
        <TrendingUp className="w-4 h-4 mr-1" />
        Adv
      </Button>

      <Button
        variant="outline"
        size="sm"
        className="border-red text-red"
        onClick={() => handleQuickRoll('1d20', { disadvantage: true })}
      >
        <TrendingDown className="w-4 h-4 mr-1" />
        Dis
      </Button>

      <Button
        variant="outline"
        size="sm"
        onClick={() => setShowCustomModal(true)}
      >
        Custom...
      </Button>

      <CustomRollModal
        tableId={tableId}
        open={showCustomModal}
        onOpenChange={setShowCustomModal}
      />
    </div>
  );
}
```

### Custom Roll Modal
```typescript
function CustomRollModal({ tableId, open, onOpenChange }: CustomRollModalProps) {
  const [notation, setNotation] = useState('');
  const [reason, setReason] = useState('');
  const [advantage, setAdvantage] = useState(false);
  const [disadvantage, setDisadvantage] = useState(false);

  const handleRoll = async () => {
    try {
      await rollDice(tableId, notation, { reason, advantage, disadvantage });
      toast.success('Dice rolled!');
      onOpenChange(false);
      setNotation('');
      setReason('');
    } catch (error) {
      toast.error(error.message);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Custom Dice Roll</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          <div>
            <Label htmlFor="notation">Dice Notation</Label>
            <Input
              id="notation"
              placeholder="e.g., 3d6+5, 1d20, 2d8-2"
              value={notation}
              onChange={(e) => setNotation(e.target.value)}
              className="font-mono"
            />
            <p className="text-xs text-gray-400 mt-1">
              Format: {'{count}'}d{'{sides}'}[+/-{'{modifier}'}]
            </p>
          </div>

          <div>
            <Label htmlFor="reason">Reason (optional)</Label>
            <Input
              id="reason"
              placeholder="e.g., Attack roll, Perception check"
              value={reason}
              onChange={(e) => setReason(e.target.value)}
            />
          </div>

          <div className="flex gap-4">
            <div className="flex items-center gap-2">
              <Checkbox
                id="advantage"
                checked={advantage}
                onCheckedChange={(checked) => {
                  setAdvantage(checked as boolean);
                  if (checked) setDisadvantage(false);
                }}
              />
              <Label htmlFor="advantage">Advantage</Label>
            </div>

            <div className="flex items-center gap-2">
              <Checkbox
                id="disadvantage"
                checked={disadvantage}
                onCheckedChange={(checked) => {
                  setDisadvantage(checked as boolean);
                  if (checked) setAdvantage(false);
                }}
              />
              <Label htmlFor="disadvantage">Disadvantage</Label>
            </div>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Cancel
          </Button>
          <Button onClick={handleRoll} disabled={!notation.trim()}>
            Roll Dice
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

### Integrate with Chat
```typescript
// In TablePage component
export default function TablePage() {
  const [messages, setMessages] = useState<Message[]>([]);
  const [rolls, setRolls] = useState<DiceRoll[]>([]);
  const { socket } = useSocketContext();

  useEffect(() => {
    if (!socket) return;

    // Listen for dice rolls
    socket.on('roll:new', ({ roll }: { roll: DiceRoll }) => {
      setRolls((prev) => [...prev, roll]);
    });

    return () => {
      socket.off('roll:new');
    };
  }, [socket]);

  // Merge messages and rolls chronologically
  const timeline = useMemo(() => {
    const items = [
      ...messages.map((m) => ({ type: 'message', data: m, createdAt: m.createdAt })),
      ...rolls.map((r) => ({ type: 'roll', data: r, createdAt: r.createdAt })),
    ];

    return items.sort((a, b) =>
      new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()
    );
  }, [messages, rolls]);

  return (
    <div className="flex-1 overflow-y-auto p-4">
      {timeline.map((item, idx) => {
        if (item.type === 'message') {
          return <MessageCard key={item.data.id} message={item.data} />;
        } else {
          return <DiceRollCard key={item.data.id} roll={item.data} />;
        }
      })}
    </div>
  );
}
```

### Animation Keyframes (CSS)
```css
@keyframes spin-dice {
  0% { transform: rotate(0deg); }
  50% { transform: rotate(180deg); }
  100% { transform: rotate(360deg); }
}

@keyframes pulse-green {
  0%, 100% { box-shadow: 0 0 0 0 rgba(57, 255, 20, 0.7); }
  50% { box-shadow: 0 0 0 10px rgba(57, 255, 20, 0); }
}

.spin-dice {
  animation: spin-dice 0.3s ease-out;
}

.pulse-green {
  animation: pulse-green 0.6s ease-out 2;
}
```

### Helper Functions
```typescript
// Extract dice sides from notation
function getDiceSides(notation: string): number {
  const match = notation.match(/d(\d+)/i);
  return match ? parseInt(match[1], 10) : 20;
}

// Format roll result for display
function formatRollResult(roll: DiceRoll): string {
  if (roll.type === 'advantage' || roll.type === 'disadvantage') {
    const [first, second] = roll.rolls;
    const used = roll.type === 'advantage' ? Math.max(first, second) : Math.min(first, second);
    const unused = used === first ? second : first;
    return `[~~${unused}~~, **${used}**] = ${roll.total}`;
  }

  return `[${roll.rolls.join(', ')}] = ${roll.total}`;
}
```

### Testing

**Test scenarios:**
- Dice roll card displays in chat after roll
- Critical hit shows gold highlight
- Critical miss shows red highlight
- Advantage shows both rolls with strikethrough
- Disadvantage shows both rolls with strikethrough
- Dice icons display correctly for each type
- Roll animation plays on new roll
- Quick roll buttons work (d20, adv, dis)
- Custom roll modal accepts notation
- Rolls and messages sort chronologically

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
