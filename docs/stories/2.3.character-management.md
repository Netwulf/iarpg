# Story 2.3: Character Management (List/Edit/Delete)

## Status
Draft

## Story
**As a** User,
**I want** to view all my characters, edit their details, and delete characters I no longer need,
**so that** I can manage my character roster effectively.

## Acceptance Criteria
1. Character list page displays all user's characters at `/characters`
2. Each character card shows name, race, class, level, HP, and thumbnail
3. Character cards have "View", "Edit", "Delete" action buttons
4. Character edit page allows updating name, background, notes, and avatar
5. Character deletion shows confirmation dialog before removing
6. Deleted characters are permanently removed from database
7. Character list shows empty state if user has no characters
8. Empty state has "Create Character" CTA button

## Tasks / Subtasks

- [ ] Create character list page (AC: 1, 2)
  - [ ] Create `/characters` route
  - [ ] Fetch user's characters from API (GET `/api/characters`)
  - [ ] Display characters in grid layout (3-4 per row on desktop)
  - [ ] Show character card for each character
  - [ ] Handle loading state

- [ ] Design character card component (AC: 2, 3)
  - [ ] Display character avatar (or placeholder icon)
  - [ ] Display name (h3 heading)
  - [ ] Display race, class, level badge
  - [ ] Display current/max HP
  - [ ] Add action buttons: View, Edit, Delete (icon buttons)
  - [ ] Add hover effect (green neon border)

- [ ] Implement empty state (AC: 7, 8)
  - [ ] Show when `characters.length === 0`
  - [ ] Display message: "No characters yet"
  - [ ] Add description: "Create your first character to start playing"
  - [ ] Add "Create Character" button â†’ `/characters/new`
  - [ ] Use EmptyState component from Front-End Spec

- [ ] Create character edit page (AC: 4)
  - [ ] Create `/characters/[id]/edit` route
  - [ ] Fetch character data
  - [ ] Create form with editable fields:
    - Name (text input)
    - Background (text input)
    - Notes (textarea)
    - Avatar (file upload - optional for MVP)
  - [ ] Add "Save Changes" and "Cancel" buttons
  - [ ] Handle form validation

- [ ] Implement character update API (AC: 4)
  - [ ] PATCH `/api/characters/{id}` endpoint
  - [ ] Validate user owns character before updating
  - [ ] Update only provided fields (partial update)
  - [ ] Return updated character
  - [ ] Return 403 if user doesn't own character

- [ ] Implement delete confirmation (AC: 5)
  - [ ] Create DeleteCharacterDialog component
  - [ ] Show character name in confirmation message
  - [ ] Add "Cancel" and "Delete" buttons
  - [ ] "Delete" button is red/destructive variant
  - [ ] Close dialog on cancel or successful delete

- [ ] Implement character deletion (AC: 6)
  - [ ] DELETE `/api/characters/{id}` endpoint
  - [ ] Validate user owns character
  - [ ] Check if character is in active tables (warn if yes)
  - [ ] Delete character from database (cascade deletes messages)
  - [ ] Return 204 No Content on success
  - [ ] Return 403 if user doesn't own character

- [ ] Handle post-delete state (AC: 6)
  - [ ] Remove character from list UI (optimistic update)
  - [ ] Show success toast: "Character deleted"
  - [ ] If last character deleted, show empty state

- [ ] Add character list API endpoint (AC: 1)
  - [ ] GET `/api/characters` endpoint (already defined)
  - [ ] Filter characters by authenticated user ID
  - [ ] Return array of characters
  - [ ] Include computed fields (ability modifiers, etc.)

- [ ] Make character list responsive (AC: 2)
  - [ ] Mobile (<640px): 1 card per row, stacked
  - [ ] Tablet (640-1024px): 2 cards per row
  - [ ] Desktop (>1024px): 3-4 cards per row
  - [ ] Use CSS Grid with responsive columns

## Dev Notes

### Character List API Response
**[Source: Architecture Section 5.1.3 - Character Endpoints]**

```typescript
GET /api/characters

Response 200:
{
  characters: [
    {
      id: "clxxx",
      name: "Thorin Ironforge",
      race: "Dwarf",
      class: "Fighter",
      level: 5,
      hp: 42,
      maxHp: 42,
      ac: 18,
      avatarUrl: null,
      createdAt: "2025-09-30T..."
    },
    // ... more characters
  ]
}
```

### Character Card Component Example
```typescript
function CharacterCard({ character }: { character: Character }) {
  return (
    <Card className="p-4 hover:border-green-neon transition-colors">
      <div className="flex items-start gap-4">
        <Avatar className="h-16 w-16">
          <AvatarImage src={character.avatarUrl} />
          <AvatarFallback>{character.name[0]}</AvatarFallback>
        </Avatar>

        <div className="flex-1">
          <h3 className="text-h4 font-bold">{character.name}</h3>
          <p className="text-small text-gray-400">
            Level {character.level} {character.race} {character.class}
          </p>
          <p className="text-small text-gray-400">
            HP: {character.hp}/{character.maxHp}
          </p>
        </div>

        <div className="flex gap-2">
          <Button variant="ghost" size="sm" asChild>
            <Link href={`/characters/${character.id}`}>View</Link>
          </Button>
          <Button variant="ghost" size="sm" asChild>
            <Link href={`/characters/${character.id}/edit`}>Edit</Link>
          </Button>
          <Button
            variant="ghost"
            size="sm"
            onClick={() => handleDelete(character.id)}
          >
            Delete
          </Button>
        </div>
      </div>
    </Card>
  );
}
```

### Empty State Component
**[Source: Front-End Spec Section 6.3 - Empty State]**

```typescript
function EmptyState() {
  return (
    <div className="flex flex-col items-center justify-center min-h-[400px] text-center">
      <div className="text-6xl mb-4">ðŸŽ²</div>
      <h2 className="text-h2 font-bold mb-2">No characters yet</h2>
      <p className="text-body text-gray-400 mb-6 max-w-md">
        Create your first character to start your adventure in IA-RPG
      </p>
      <Button size="lg" asChild>
        <Link href="/characters/new">Create Character</Link>
      </Button>
    </div>
  );
}
```

### Delete Confirmation Dialog
```typescript
function DeleteCharacterDialog({
  character,
  open,
  onOpenChange,
  onConfirm,
}: {
  character: Character;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onConfirm: () => void;
}) {
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Delete Character?</DialogTitle>
        </DialogHeader>
        <p className="text-body text-gray-400">
          Are you sure you want to delete <strong>{character.name}</strong>?
          This action cannot be undone.
        </p>
        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Cancel
          </Button>
          <Button variant="destructive" onClick={onConfirm}>
            Delete
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

### API Endpoints
**[Source: Architecture Section 5.1.3]**

**GET /api/characters** - List user's characters
**GET /api/characters/:id** - Get character details
**PATCH /api/characters/:id** - Update character
**DELETE /api/characters/:id** - Delete character

### Update API Controller Example
```typescript
// apps/api/src/controllers/characters.controller.ts
export const charactersController = {
  async update(req: Request, res: Response, next: NextFunction) {
    try {
      const { id } = req.params;
      const userId = req.user!.id;
      const updates = req.body;

      // Verify ownership
      const character = await prisma.character.findUnique({ where: { id } });
      if (!character || character.userId !== userId) {
        return res.status(403).json({ error: 'Forbidden' });
      }

      // Update character
      const updated = await prisma.character.update({
        where: { id },
        data: updates,
      });

      res.json({ character: updated });
    } catch (error) {
      next(error);
    }
  },

  async delete(req: Request, res: Response, next: NextFunction) {
    try {
      const { id } = req.params;
      const userId = req.user!.id;

      // Verify ownership
      const character = await prisma.character.findUnique({ where: { id } });
      if (!character || character.userId !== userId) {
        return res.status(403).json({ error: 'Forbidden' });
      }

      // Delete character (cascades to messages via Prisma)
      await prisma.character.delete({ where: { id } });

      res.status(204).send();
    } catch (error) {
      next(error);
    }
  },
};
```

### Responsive Grid Layout
**[Source: Front-End Spec Section 9 - Responsiveness]**

```tsx
<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
  {characters.map((character) => (
    <CharacterCard key={character.id} character={character} />
  ))}
</div>
```

### Testing

**Test scenarios:**
- Character list displays all user's characters
- Empty state shows when no characters exist
- Character card displays correct information
- Edit form saves changes correctly
- Delete confirmation dialog shows before deletion
- Character is deleted from database
- API returns 403 if user tries to edit/delete another user's character
- Responsive layout works on mobile, tablet, desktop

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
