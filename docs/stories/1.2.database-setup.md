# Story 1.2: Database Setup (Supabase + Prisma)

## Status
Draft

## Story
**As a** Developer,
**I want** to set up Supabase PostgreSQL database and configure Prisma ORM with the complete data schema,
**so that** the application has a fully functional database layer ready for authentication and feature implementation.

## Acceptance Criteria
1. Supabase project is created and configured with PostgreSQL 15+ database
2. Prisma is installed and configured in `packages/db` workspace
3. Complete database schema is defined in `schema.prisma` with all 6 models (User, Character, Table, TableMember, Message, CombatEncounter)
4. Initial migration is created and applied successfully to Supabase database
5. Prisma Client is generated and exported from `packages/db`
6. Database connection is tested and verified working
7. Seed script is created for initial development data (optional for MVP)

## Tasks / Subtasks

- [ ] Create Supabase project and obtain credentials (AC: 1)
  - [ ] Sign up/login to Supabase dashboard
  - [ ] Create new project: "iarpg-dev" (development)
  - [ ] Note project URL and anon key
  - [ ] Obtain service role key (for backend)
  - [ ] Copy database connection string (direct + pooled)

- [ ] Configure environment variables (AC: 1)
  - [ ] Update `.env.example` with Supabase credentials format
  - [ ] Create `.env.local` in `apps/web` with Supabase public keys
  - [ ] Create `.env` in `apps/api` with Supabase service key
  - [ ] Create `.env` in `packages/db` with DATABASE_URL

- [ ] Initialize Prisma in packages/db (AC: 2)
  - [ ] Run `pnpm add prisma @prisma/client` in packages/db
  - [ ] Run `pnpm prisma init` to create prisma directory
  - [ ] Configure `schema.prisma` datasource with DATABASE_URL
  - [ ] Configure `schema.prisma` generator for Prisma Client

- [ ] Define User model in schema.prisma (AC: 3)
  - [ ] Add User model with all fields (id, email, username, passwordHash, tier, etc.)
  - [ ] Add unique constraints on email and username
  - [ ] Add indexes for email and username lookups
  - [ ] Add relations to Character, Table, TableMember, Message

- [ ] Define Character model in schema.prisma (AC: 3)
  - [ ] Add Character model with D&D 5e fields (ability scores, HP, AC, etc.)
  - [ ] Use Json type for flexible data (proficiencies, spells, equipment)
  - [ ] Add relation to User (many-to-one)
  - [ ] Add relation to TableMember and Message
  - [ ] Add index on userId

- [ ] Define Table model in schema.prisma (AC: 3)
  - [ ] Add Table model with playStyle, privacy, state fields
  - [ ] Add unique constraint on inviteCode
  - [ ] Add compound index on privacy + state for discovery
  - [ ] Add relations to User (owner), TableMember, Message, CombatEncounter

- [ ] Define TableMember model in schema.prisma (AC: 3)
  - [ ] Add TableMember model for many-to-many User-Table relationship
  - [ ] Add unique constraint on [tableId, userId] (user can only join once)
  - [ ] Add indexes on tableId and userId
  - [ ] Add relations to Table, User, Character

- [ ] Define Message model in schema.prisma (AC: 3)
  - [ ] Add Message model with type, content, diceRolls, reactions
  - [ ] Use Json type for diceRolls and reactions arrays
  - [ ] Add parentId for threading (async play)
  - [ ] Add compound index on [tableId, createdAt] for pagination
  - [ ] Add relations to Table, User, Character

- [ ] Define CombatEncounter model in schema.prisma (AC: 3)
  - [ ] Add CombatEncounter model with round, state fields
  - [ ] Use Json type for combatants array
  - [ ] Add relation to Table
  - [ ] Add index on tableId

- [ ] Create and apply initial migration (AC: 4)
  - [ ] Run `pnpm prisma migrate dev --name init` in packages/db
  - [ ] Verify migration SQL is correct
  - [ ] Check Supabase dashboard to confirm tables created
  - [ ] Verify all indexes and constraints applied

- [ ] Generate and export Prisma Client (AC: 5)
  - [ ] Run `pnpm prisma generate` to create Prisma Client
  - [ ] Create `packages/db/src/index.ts` exporting PrismaClient singleton
  - [ ] Add proper TypeScript types export
  - [ ] Update `packages/db/package.json` with correct exports field

- [ ] Test database connection (AC: 6)
  - [ ] Create test script in `packages/db/tests/connection.test.ts`
  - [ ] Test connecting to database via Prisma Client
  - [ ] Test querying database (e.g., `prisma.user.count()`)
  - [ ] Run test with `pnpm test` in packages/db workspace

- [ ] Create seed script (AC: 7)
  - [ ] Create `packages/db/prisma/seed.ts` file
  - [ ] Add sample User records (2-3 test users)
  - [ ] Add sample Character records
  - [ ] Add sample Table records
  - [ ] Configure `package.json` with prisma seed command
  - [ ] Run `pnpm prisma db seed` to test

- [ ] Update workspace dependencies (AC: 5)
  - [ ] Add `@iarpg/db` dependency to `apps/api/package.json`
  - [ ] Add `@iarpg/db` dependency to `apps/web/package.json`
  - [ ] Run `pnpm install` to link workspaces
  - [ ] Test importing Prisma Client from other workspaces

- [ ] Document database setup (AC: 1, 6)
  - [ ] Update README.md with Supabase setup instructions
  - [ ] Document how to run migrations
  - [ ] Document how to seed database
  - [ ] Add troubleshooting section for common connection issues

## Dev Notes

### Supabase Configuration
**[Source: Architecture Section 2.2 - Platform and Infrastructure Choice]**

**Platform:** Supabase (managed PostgreSQL 15+)

**Why Supabase:**
- Managed PostgreSQL database (no DevOps overhead)
- Built-in authentication (integrates with NextAuth.js in Story 1.3)
- Built-in storage for avatars/uploads
- Free tier sufficient for MVP
- Auto-scaling connection pooling

**Supabase Dashboard Setup:**
1. Create new project at https://app.supabase.com
2. Select region: **US East** (minimize latency)
3. Choose PostgreSQL version: **15+**
4. Note credentials:
   - **Project URL:** `https://xxxxx.supabase.co`
   - **Anon Public Key:** `eyJhbGc...` (for frontend)
   - **Service Role Key:** `eyJhbGc...` (for backend, DO NOT expose)
   - **Database URL (Direct):** `postgresql://postgres.[ref]:[password]@aws-0-us-east-1.pooler.supabase.com:5432/postgres`
   - **Database URL (Pooler):** `postgresql://postgres.[ref]:[password]@aws-0-us-east-1.pooler.supabase.com:6543/postgres?pgbouncer=true`

**Connection String Usage:**
- Use **Direct URL** for migrations: `DATABASE_URL`
- Use **Pooler URL** for application: `DIRECT_URL` (Prisma needs both)

### Prisma Configuration
**[Source: Architecture Section 3 - Tech Stack]**

**ORM:** Prisma **5.20+**

**Why Prisma:**
- Type-safe database queries
- Automatic TypeScript types generation
- Migration system built-in
- Excellent DX with Prisma Studio
- Works perfectly with monorepos

**`packages/db/prisma/schema.prisma` structure:**
```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Models follow...
```

**Note:** `directUrl` is required for Supabase connection pooler compatibility.

### Complete Database Schema
**[Source: Architecture Section 9 - Database Schema]**

**6 Core Models:**

1. **User** - Authentication and user profiles
2. **Character** - D&D 5e character sheets
3. **Table** - RPG tables/sessions
4. **TableMember** - Many-to-many User-Table with Character
5. **Message** - Chat messages and posts
6. **CombatEncounter** - Combat tracking

**Full schema.prisma (COPY-PASTE READY):**

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  username         String    @unique
  passwordHash     String?
  tier             String    @default("free") // free, premium, master
  stripeCustomerId String?   @unique
  avatar           String?
  bio              String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  characters       Character[]
  ownedTables      Table[]         @relation("TableOwner")
  tableMemberships TableMember[]
  messages         Message[]

  @@index([email])
  @@index([username])
}

model Character {
  id              String   @id @default(cuid())
  userId          String
  name            String
  race            String
  class           String
  level           Int      @default(1)

  // Ability Scores
  strength        Int
  dexterity       Int
  constitution    Int
  intelligence    Int
  wisdom          Int
  charisma        Int

  // Core Stats
  proficiencyBonus Int     @default(2)
  hp              Int
  maxHp           Int
  tempHp          Int      @default(0)
  ac              Int
  initiative      Int
  speed           Int      @default(30)

  // Skills & Proficiencies (JSON array of strings)
  proficiencies   Json     @default("[]")

  // Spells (JSON array of Spell objects)
  spells          Json     @default("[]")

  // Equipment (JSON array of EquipmentItem objects)
  equipment       Json     @default("[]")

  // Character Details
  background      String
  notes           String?
  avatarUrl       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  tableMemberships TableMember[]
  messages        Message[]

  @@index([userId])
}

model Table {
  id              String   @id @default(cuid())
  ownerId         String
  name            String
  description     String
  playStyle       String   // sync, async, solo
  privacy         String   @default("private") // private, public, spectator
  inviteCode      String   @unique
  state           String   @default("setup") // setup, active, paused, completed
  schedule        String?
  maxPlayers      Int      @default(6)
  tags            String[] // Array of strings
  rulesVariant    String   @default("standard") // standard, homebrew
  thumbnailUrl    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastActivityAt  DateTime @default(now())

  // Relations
  owner           User            @relation("TableOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members         TableMember[]
  messages        Message[]
  combatEncounters CombatEncounter[]

  @@index([ownerId])
  @@index([privacy, state]) // For public table discovery
  @@index([inviteCode])
}

model TableMember {
  id          String   @id @default(cuid())
  tableId     String
  userId      String
  characterId String
  role        String   @default("player") // dm, player
  status      String   @default("active") // active, invited, left
  joinedAt    DateTime @default(now())

  // Relations
  table       Table     @relation(fields: [tableId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([tableId, userId]) // User can only join table once
  @@index([tableId])
  @@index([userId])
}

model Message {
  id          String   @id @default(cuid())
  tableId     String
  userId      String
  characterId String?  // Null for OOC messages
  type        String   // ic, ooc, dm-note, system
  content     String   @db.Text

  // Embedded data (JSON)
  diceRolls   Json     @default("[]") // Array of DiceRoll objects
  reactions   Json     @default("[]") // Array of Reaction objects

  parentId    String?  // For threading (async play)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  table       Table     @relation(fields: [tableId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  character   Character? @relation(fields: [characterId], references: [id], onDelete: SetNull)
  parent      Message?  @relation("MessageThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Message[] @relation("MessageThread")

  @@index([tableId, createdAt]) // For message history pagination
  @@index([parentId])
}

model CombatEncounter {
  id          String   @id @default(cuid())
  tableId     String
  name        String
  round       Int      @default(1)
  state       String   @default("setup") // setup, active, ended

  // Combatants (JSON array of Combatant objects)
  combatants  Json     @default("[]")

  createdAt   DateTime @default(now())
  endedAt     DateTime?

  // Relations
  table       Table    @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
}
```

### Key Indexes Explained
**[Source: Architecture Section 9 - Database Schema]**

**User indexes:**
- `@@index([email])` - Fast login lookups by email
- `@@index([username])` - Fast username availability checks

**Table indexes:**
- `@@index([privacy, state])` - Critical for public table discovery (browse tables)
- `@@index([inviteCode])` - Fast join-by-code lookups

**Message indexes:**
- `@@index([tableId, createdAt])` - Efficient message pagination in chat
- `@@index([parentId])` - Fast threading queries for async play

**TableMember indexes:**
- `@@unique([tableId, userId])` - Prevents duplicate joins
- `@@index([tableId])`, `@@index([userId])` - Fast membership queries

### JSON Fields Rationale
**[Source: Architecture Section 9]**

**Why JSON instead of relations:**
- `Character.spells`, `Character.equipment`, `Character.proficiencies`
  - **Reason:** D&D 5e data is highly variable, JSON avoids complex many-to-many tables
  - **Trade-off:** Can't efficiently query "all characters with Fireball spell" (acceptable for MVP)

- `Message.diceRolls`, `Message.reactions`
  - **Reason:** Always queried with parent message, never separately
  - **Trade-off:** Simpler schema, faster message queries

- `CombatEncounter.combatants`
  - **Reason:** Combat data is ephemeral, updated frequently as single document
  - **Trade-off:** Better performance for combat round updates

### Prisma Client Export Pattern
**[Source: Architecture Section 9]**

**`packages/db/src/index.ts`:**
```typescript
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma =
  globalForPrisma.prisma ??
  new PrismaClient({
    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
  });

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;

export * from '@prisma/client';
```

**Why singleton pattern:**
- Prevents multiple Prisma Client instances (connection pool exhaustion)
- Hot reload safe (Next.js dev mode)
- Works in both frontend (API routes) and backend (Express)

### Environment Variables Configuration
**[Source: Architecture Section 14.2 - Deployment]**

**`packages/db/.env`:**
```bash
# Supabase Database URLs
DATABASE_URL="postgresql://postgres.[ref]:[password]@aws-0-us-east-1.pooler.supabase.com:6543/postgres?pgbouncer=true"
DIRECT_URL="postgresql://postgres.[ref]:[password]@aws-0-us-east-1.pooler.supabase.com:5432/postgres"
```

**`apps/web/.env.local`:**
```bash
# Supabase Public Keys (safe for frontend)
NEXT_PUBLIC_SUPABASE_URL="https://xxxxx.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJhbGc..."
```

**`apps/api/.env`:**
```bash
# Supabase Service Key (NEVER expose to frontend)
SUPABASE_SERVICE_KEY="eyJhbGc..."
DATABASE_URL="postgresql://postgres.[ref]:[password]@aws-0-us-east-1.pooler.supabase.com:6543/postgres?pgbouncer=true"
```

### Seed Data Structure
**[Source: Best practices for development]**

**`packages/db/prisma/seed.ts`:**
```typescript
import { PrismaClient } from '@prisma/client';
import bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

async function main() {
  // Create test users
  const user1 = await prisma.user.create({
    data: {
      email: 'test@iarpg.com',
      username: 'testuser',
      passwordHash: await bcrypt.hash('password123', 10),
      tier: 'free',
    },
  });

  // Create test character
  await prisma.character.create({
    data: {
      userId: user1.id,
      name: 'Thorin Ironforge',
      race: 'Dwarf',
      class: 'Fighter',
      level: 5,
      strength: 16,
      dexterity: 14,
      constitution: 15,
      intelligence: 10,
      wisdom: 12,
      charisma: 8,
      proficiencyBonus: 3,
      hp: 42,
      maxHp: 42,
      ac: 18,
      initiative: 2,
      background: 'Soldier',
    },
  });

  console.log('✅ Database seeded successfully');
}

main()
  .catch((e) => {
    console.error('❌ Error seeding database:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

**Configure in `packages/db/package.json`:**
```json
{
  "prisma": {
    "seed": "tsx prisma/seed.ts"
  }
}
```

### Migration Commands Reference
**[Source: Architecture Section 13.2 - Development Workflow]**

```bash
# Create and apply migration
pnpm --filter @iarpg/db prisma migrate dev --name init

# Generate Prisma Client
pnpm --filter @iarpg/db prisma generate

# Open Prisma Studio (database GUI)
pnpm --filter @iarpg/db prisma studio

# Seed database
pnpm --filter @iarpg/db prisma db seed

# Reset database (WARNING: deletes all data)
pnpm --filter @iarpg/db prisma migrate reset
```

**From project root (using root package.json scripts):**
```bash
pnpm db:migrate    # Run migrations
pnpm db:studio     # Open Prisma Studio
```

### Testing

**Test Framework:** Vitest 1.6+
**Test File Location:** `packages/db/tests/connection.test.ts`

**Testing Standards:**
**[Source: Architecture Section 16 - Testing Strategy]**

- Test database connection via Prisma Client
- Test basic CRUD operations
- Verify migrations applied correctly
- Test Prisma Client can be imported from other workspaces

**Sample test:**
```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { prisma } from '../src/index';

describe('Database Connection', () => {
  afterAll(async () => {
    await prisma.$disconnect();
  });

  it('should connect to database', async () => {
    const result = await prisma.$queryRaw`SELECT 1 as value`;
    expect(result).toBeDefined();
  });

  it('should count users', async () => {
    const count = await prisma.user.count();
    expect(count).toBeGreaterThanOrEqual(0);
  });
});
```

**For this story:**
- Test database connection succeeds
- Test Prisma Client can query database
- Test workspace imports work (`apps/api` can import `@iarpg/db`)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
