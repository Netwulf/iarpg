# Story 8.2: Premium Features & Feature Gating

## Status
Draft

## Story
**As a** premium/master subscriber,
**I want** access to exclusive features,
**so that** I get value from my subscription and enhanced gameplay.

## Acceptance Criteria
1. Free tier: 3 characters max, 2 active tables max, 3 AI suggestions/combat
2. Premium tier: Unlimited characters, 10 active tables, unlimited AI suggestions
3. Master tier: Everything in Premium + unlimited DM tables + advanced AI
4. Feature gates enforce limits based on user tier
5. Upgrade CTA shown when free user hits limit
6. Premium badge displayed next to premium/master users in UI
7. Custom character themes available only to premium/master users
8. Advanced AI DM features (campaign memory, NPC generator) only for master tier

## Tasks / Subtasks

- [ ] Define tier limits constants (AC: 1, 2, 3)
  - [ ] Create `apps/api/src/constants/tiers.ts`
  - [ ] Free: 3 characters, 2 tables, 3 AI suggestions/combat
  - [ ] Premium: unlimited characters, 10 tables, unlimited AI
  - [ ] Master: unlimited characters, unlimited tables, unlimited AI, advanced features
  - [ ] Export tier limits object

- [ ] Implement character creation limit (AC: 1, 2)
  - [ ] In POST `/api/characters`, check current character count
  - [ ] Free tier: reject if count >= 3
  - [ ] Premium/Master: allow unlimited
  - [ ] Return 403 with upgrade CTA if limit reached

- [ ] Implement table creation limit (AC: 1, 2, 3)
  - [ ] In POST `/api/tables`, check current table count (where ownerId = userId)
  - [ ] Free tier: reject if count >= 2
  - [ ] Premium tier: reject if count >= 10
  - [ ] Master tier: allow unlimited
  - [ ] Return 403 with upgrade CTA if limit reached

- [ ] Implement AI suggestion limit (AC: 1, 2)
  - [ ] In POST `/api/tables/{tableId}/combat/{encounterId}/suggest`
  - [ ] Free tier: count suggestions for current combat, reject if >= 3
  - [ ] Premium/Master: allow unlimited
  - [ ] Return 403 with upgrade CTA if limit reached

- [ ] Create feature gate utility (AC: 4)
  - [ ] Function `checkFeatureAccess(userId, feature)`
  - [ ] Queries user tier
  - [ ] Returns { allowed: boolean, upgrade: boolean, message: string }
  - [ ] Use in controllers before feature execution

- [ ] Build upgrade CTA modal (AC: 5)
  - [ ] Component: `<UpgradeModal />`
  - [ ] Props: feature name, required tier
  - [ ] Shows pricing comparison
  - [ ] "Upgrade to Premium" CTA button
  - [ ] Redirects to /pricing

- [ ] Add premium badge to UI (AC: 6)
  - [ ] Badge component: `<PremiumBadge tier="premium" />`
  - [ ] Show next to username in:
    - Chat messages
    - Player list
    - Character cards
    - User profile
  - [ ] Gold color for premium, purple for master

- [ ] Implement custom character themes (AC: 7)
  - [ ] Add `theme` field to Character model (nullable string)
  - [ ] Theme options: default, dark-fantasy, cyberpunk, steampunk, anime
  - [ ] Theme selector only shown to premium/master users
  - [ ] Apply theme CSS classes to character sheet

- [ ] Create theme selector component (AC: 7)
  - [ ] Component: `<ThemeSelector />`
  - [ ] Only visible if user.tier = premium || master
  - [ ] Dropdown with theme previews
  - [ ] Saves theme to character model

- [ ] Implement advanced AI features for Master (AC: 8)
  - [ ] Feature: Campaign Memory (stores DM notes, NPCs, plot points)
  - [ ] Feature: NPC Generator (AI generates full NPC stat blocks)
  - [ ] Feature: Plot Assistant (suggests story hooks, twists)
  - [ ] Guard endpoints with `requireMaster` middleware

- [ ] Build campaign memory system (AC: 8)
  - [ ] Model: `CampaignMemory { tableId, key, value, category }`
  - [ ] Categories: npcs, locations, plot_points, secrets
  - [ ] CRUD endpoints: GET/POST/PATCH/DELETE `/api/tables/{tableId}/memory`
  - [ ] AI can query memory for context

- [ ] Create NPC generator endpoint (AC: 8)
  - [ ] POST `/api/tables/{tableId}/npcs/generate`
  - [ ] Requires master tier
  - [ ] Accepts: race, class, level, personality traits
  - [ ] Claude API generates: name, stats, backstory, motivations
  - [ ] Returns full NPC JSON

- [ ] Build feature comparison widget (AC: 5)
  - [ ] Component: `<FeatureComparison />`
  - [ ] Shows side-by-side Free vs Premium vs Master
  - [ ] Highlights locked features for current tier
  - [ ] Used in upgrade modal

- [ ] Add tier info to user profile (AC: 6)
  - [ ] Show tier badge (Free/Premium/Master)
  - [ ] Show subscription status
  - [ ] Show features unlocked
  - [ ] "Upgrade" button for free/premium users

- [ ] Handle edge cases (AC: 4, 5)
  - [ ] User downgrades mid-session → show warning
  - [ ] User exceeds limit after downgrade → soft lock (read-only)
  - [ ] Free trial ends → show renewal prompt
  - [ ] Payment fails → show payment update CTA

## Dev Notes

### Tier Limits Configuration
**[Source: PRD Section 3.3 - Monetization Strategy]**

```typescript
// apps/api/src/constants/tiers.ts
export const TIER_LIMITS = {
  free: {
    characters: 3,
    tables: 2,
    aiSuggestionsPerCombat: 3,
    features: {
      unlimitedAI: false,
      customThemes: false,
      campaignMemory: false,
      npcGenerator: false,
      plotAssistant: false,
    },
  },
  premium: {
    characters: Infinity,
    tables: 10,
    aiSuggestionsPerCombat: Infinity,
    features: {
      unlimitedAI: true,
      customThemes: true,
      campaignMemory: false,
      npcGenerator: false,
      plotAssistant: false,
    },
  },
  master: {
    characters: Infinity,
    tables: Infinity,
    aiSuggestionsPerCombat: Infinity,
    features: {
      unlimitedAI: true,
      customThemes: true,
      campaignMemory: true,
      npcGenerator: true,
      plotAssistant: true,
    },
  },
} as const;

export type Tier = keyof typeof TIER_LIMITS;
export type Feature = keyof typeof TIER_LIMITS.free.features;
```

### Feature Gate Utility
```typescript
// apps/api/src/utils/featureGate.ts
import { prisma } from '@iarpg/db';
import { TIER_LIMITS, Feature } from '../constants/tiers';

interface FeatureAccessResult {
  allowed: boolean;
  upgrade: boolean;
  message: string;
  requiredTier?: 'premium' | 'master';
}

export async function checkFeatureAccess(
  userId: string,
  feature: Feature
): Promise<FeatureAccessResult> {
  const user = await prisma.user.findUnique({
    where: { id: userId },
    select: { tier: true },
  });

  if (!user) {
    return {
      allowed: false,
      upgrade: false,
      message: 'User not found',
    };
  }

  const tier = user.tier as 'free' | 'premium' | 'master';
  const hasAccess = TIER_LIMITS[tier].features[feature];

  if (hasAccess) {
    return {
      allowed: true,
      upgrade: false,
      message: 'Access granted',
    };
  }

  // Determine required tier
  let requiredTier: 'premium' | 'master' = 'premium';
  if (!TIER_LIMITS.premium.features[feature]) {
    requiredTier = 'master';
  }

  return {
    allowed: false,
    upgrade: true,
    message: `This feature requires ${requiredTier} subscription`,
    requiredTier,
  };
}

export async function checkResourceLimit(
  userId: string,
  resource: 'characters' | 'tables'
): Promise<FeatureAccessResult> {
  const user = await prisma.user.findUnique({
    where: { id: userId },
    select: { tier: true },
  });

  if (!user) {
    return {
      allowed: false,
      upgrade: false,
      message: 'User not found',
    };
  }

  const tier = user.tier as 'free' | 'premium' | 'master';
  const limit = TIER_LIMITS[tier][resource];

  // Count current resources
  let count = 0;
  if (resource === 'characters') {
    count = await prisma.character.count({
      where: { userId },
    });
  } else if (resource === 'tables') {
    count = await prisma.table.count({
      where: { ownerId: userId },
    });
  }

  if (count < limit) {
    return {
      allowed: true,
      upgrade: false,
      message: 'Within limit',
    };
  }

  return {
    allowed: false,
    upgrade: true,
    message: `You've reached your ${resource} limit (${limit}). Upgrade to create more.`,
    requiredTier: tier === 'free' ? 'premium' : 'master',
  };
}
```

### Character Creation with Limit
```typescript
// apps/api/src/controllers/character.controller.ts (updated)
export const characterController = {
  async create(req: Request, res: Response, next: NextFunction) {
    try {
      const userId = req.user!.id;

      // Check character limit
      const limitCheck = await checkResourceLimit(userId, 'characters');

      if (!limitCheck.allowed) {
        return res.status(403).json({
          error: limitCheck.message,
          upgrade: limitCheck.upgrade,
          requiredTier: limitCheck.requiredTier,
        });
      }

      // Proceed with character creation
      const character = await prisma.character.create({
        data: {
          ...req.body,
          userId,
        },
      });

      res.json({ character });
    } catch (error) {
      next(error);
    }
  },
};
```

### Table Creation with Limit
```typescript
// apps/api/src/controllers/table.controller.ts (updated)
export const tableController = {
  async create(req: Request, res: Response, next: NextFunction) {
    try {
      const userId = req.user!.id;

      // Check table limit
      const limitCheck = await checkResourceLimit(userId, 'tables');

      if (!limitCheck.allowed) {
        return res.status(403).json({
          error: limitCheck.message,
          upgrade: limitCheck.upgrade,
          requiredTier: limitCheck.requiredTier,
        });
      }

      // Proceed with table creation
      const table = await prisma.table.create({
        data: {
          ...req.body,
          ownerId: userId,
        },
      });

      res.json({ table });
    } catch (error) {
      next(error);
    }
  },
};
```

### Upgrade CTA Modal Component
**[Source: Front-End Spec Section 5.8 - Upgrade Flow]**

```typescript
// apps/web/src/components/UpgradeModal.tsx
'use client';

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Crown } from 'lucide-react';

interface UpgradeModalProps {
  isOpen: boolean;
  onClose: () => void;
  feature: string;
  requiredTier: 'premium' | 'master';
}

export function UpgradeModal({
  isOpen,
  onClose,
  feature,
  requiredTier,
}: UpgradeModalProps) {
  const tierDetails = {
    premium: {
      price: '$9.99/month',
      features: [
        'Unlimited characters',
        '10 active tables',
        'Unlimited AI suggestions',
        'Custom character themes',
        'Priority support',
      ],
    },
    master: {
      price: '$19.99/month',
      features: [
        'Everything in Premium',
        'Unlimited DM tables',
        'Campaign memory system',
        'AI NPC generator',
        'Plot assistant',
      ],
    },
  };

  const details = tierDetails[requiredTier];

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <div className="flex items-center gap-2 mb-2">
            <Crown className="w-6 h-6 text-yellow-500" />
            <DialogTitle className="capitalize">{requiredTier} Feature</DialogTitle>
          </div>
          <DialogDescription>
            {feature} requires a {requiredTier} subscription.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div className="text-center">
            <p className="text-3xl font-bold">{details.price}</p>
            <Badge variant="outline" className="mt-2">
              14-day free trial
            </Badge>
          </div>

          <div className="border-t border-gray-800 pt-4">
            <p className="font-semibold mb-3">Included features:</p>
            <ul className="space-y-2">
              {details.features.map((feat) => (
                <li key={feat} className="flex items-center gap-2 text-sm">
                  <span className="text-green-500">✓</span>
                  {feat}
                </li>
              ))}
            </ul>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>
            Maybe Later
          </Button>
          <Button
            onClick={() => {
              window.location.href = '/pricing';
            }}
          >
            Start Free Trial
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Usage in components:**
```typescript
// Example: Character creation page
const [showUpgrade, setShowUpgrade] = useState(false);
const [upgradeInfo, setUpgradeInfo] = useState({ feature: '', tier: 'premium' });

const handleCreateCharacter = async () => {
  const response = await fetch('/api/characters', {
    method: 'POST',
    body: JSON.stringify(characterData),
  });

  if (response.status === 403) {
    const { error, requiredTier } = await response.json();
    setUpgradeInfo({ feature: error, tier: requiredTier });
    setShowUpgrade(true);
    return;
  }

  // Success
};

return (
  <>
    {/* Character creation form */}
    <UpgradeModal
      isOpen={showUpgrade}
      onClose={() => setShowUpgrade(false)}
      feature={upgradeInfo.feature}
      requiredTier={upgradeInfo.tier}
    />
  </>
);
```

### Premium Badge Component
```typescript
// apps/web/src/components/PremiumBadge.tsx
import { Crown } from 'lucide-react';
import { Badge } from '@/components/ui/badge';

interface PremiumBadgeProps {
  tier: 'free' | 'premium' | 'master';
  size?: 'sm' | 'md';
}

export function PremiumBadge({ tier, size = 'sm' }: PremiumBadgeProps) {
  if (tier === 'free') return null;

  const colors = {
    premium: 'bg-yellow-500/20 text-yellow-500 border-yellow-500/50',
    master: 'bg-purple-500/20 text-purple-500 border-purple-500/50',
  };

  const iconSize = size === 'sm' ? 'w-3 h-3' : 'w-4 h-4';

  return (
    <Badge className={`${colors[tier]} capitalize gap-1`}>
      <Crown className={iconSize} />
      {tier}
    </Badge>
  );
}
```

**Usage:**
```typescript
// In chat message
<div className="flex items-center gap-2">
  <Avatar>
    <AvatarImage src={message.user.avatar} />
  </Avatar>
  <span className="font-medium">{message.user.username}</span>
  <PremiumBadge tier={message.user.tier} />
</div>
```

### Character Theme System
**[Source: Front-End Spec Section 4.2 - Character Sheet Themes]**

**Prisma Schema Update:**
```prisma
model Character {
  id     String  @id @default(cuid())
  userId String
  name   String
  theme  String? // default, dark-fantasy, cyberpunk, steampunk, anime

  // ... other fields
}
```

**Theme Selector Component:**
```typescript
// apps/web/src/components/ThemeSelector.tsx
'use client';

import { useState } from 'react';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { useUser } from '@/hooks/useUser';
import { Crown } from 'lucide-react';

interface ThemeSelectorProps {
  characterId: string;
  currentTheme: string | null;
  onThemeChange: (theme: string) => void;
}

const themes = [
  { value: 'default', label: 'Default', premium: false },
  { value: 'dark-fantasy', label: 'Dark Fantasy', premium: true },
  { value: 'cyberpunk', label: 'Cyberpunk', premium: true },
  { value: 'steampunk', label: 'Steampunk', premium: true },
  { value: 'anime', label: 'Anime', premium: true },
];

export function ThemeSelector({
  characterId,
  currentTheme,
  onThemeChange,
}: ThemeSelectorProps) {
  const { user } = useUser();
  const isPremium = user?.tier === 'premium' || user?.tier === 'master';

  const handleThemeChange = async (theme: string) => {
    await fetch(`/api/characters/${characterId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ theme }),
    });

    onThemeChange(theme);
  };

  return (
    <div className="space-y-2">
      <label className="text-sm font-medium flex items-center gap-2">
        Character Theme
        {!isPremium && <Crown className="w-4 h-4 text-yellow-500" />}
      </label>

      <Select
        value={currentTheme || 'default'}
        onValueChange={handleThemeChange}
        disabled={!isPremium}
      >
        <SelectTrigger>
          <SelectValue />
        </SelectTrigger>
        <SelectContent>
          {themes.map((theme) => (
            <SelectItem
              key={theme.value}
              value={theme.value}
              disabled={theme.premium && !isPremium}
            >
              <div className="flex items-center gap-2">
                {theme.label}
                {theme.premium && !isPremium && (
                  <Crown className="w-3 h-3 text-yellow-500" />
                )}
              </div>
            </SelectItem>
          ))}
        </SelectContent>
      </Select>

      {!isPremium && (
        <p className="text-xs text-gray-400">
          Unlock custom themes with{' '}
          <a href="/pricing" className="text-blue-500 underline">
            Premium
          </a>
        </p>
      )}
    </div>
  );
}
```

**Theme CSS Classes:**
```css
/* apps/web/src/styles/themes.css */
.theme-default {
  --sheet-bg: #1a1a1a;
  --sheet-border: #333;
  --sheet-accent: #3b82f6;
}

.theme-dark-fantasy {
  --sheet-bg: #0f0f0f;
  --sheet-border: #8b0000;
  --sheet-accent: #dc143c;
}

.theme-cyberpunk {
  --sheet-bg: #0a0a0a;
  --sheet-border: #00ffff;
  --sheet-accent: #ff00ff;
}

.theme-steampunk {
  --sheet-bg: #2a1810;
  --sheet-border: #8b7355;
  --sheet-accent: #cd853f;
}

.theme-anime {
  --sheet-bg: #fff5f5;
  --sheet-border: #ffc0cb;
  --sheet-accent: #ff69b4;
  color: #333;
}
```

### Campaign Memory System (Master Tier)
**[Source: Architecture Section 5.1.12 - Campaign Memory]**

**Prisma Schema:**
```prisma
model CampaignMemory {
  id        String   @id @default(cuid())
  tableId   String
  key       String   // npc_name, location_name, plot_point_id
  value     String   @db.Text // JSON-encoded data
  category  String   // npcs, locations, plot_points, secrets
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  table Table @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([tableId, key])
  @@index([tableId, category])
}

model Table {
  // ... existing fields
  campaignMemory CampaignMemory[]
}
```

**Campaign Memory Controller:**
```typescript
// apps/api/src/controllers/campaignMemory.controller.ts
import { Request, Response, NextFunction } from 'express';
import { prisma } from '@iarpg/db';

export const campaignMemoryController = {
  async list(req: Request, res: Response, next: NextFunction) {
    try {
      const { tableId } = req.params;
      const { category } = req.query;

      const memories = await prisma.campaignMemory.findMany({
        where: {
          tableId,
          ...(category && { category: category as string }),
        },
        orderBy: { updatedAt: 'desc' },
      });

      res.json({ memories });
    } catch (error) {
      next(error);
    }
  },

  async create(req: Request, res: Response, next: NextFunction) {
    try {
      const { tableId } = req.params;
      const { key, value, category } = req.body;

      const memory = await prisma.campaignMemory.create({
        data: {
          tableId,
          key,
          value: JSON.stringify(value),
          category,
        },
      });

      res.json({ memory });
    } catch (error) {
      next(error);
    }
  },

  async update(req: Request, res: Response, next: NextFunction) {
    try {
      const { tableId, memoryId } = req.params;
      const { value } = req.body;

      const memory = await prisma.campaignMemory.update({
        where: { id: memoryId },
        data: { value: JSON.stringify(value) },
      });

      res.json({ memory });
    } catch (error) {
      next(error);
    }
  },

  async delete(req: Request, res: Response, next: NextFunction) {
    try {
      const { memoryId } = req.params;

      await prisma.campaignMemory.delete({
        where: { id: memoryId },
      });

      res.json({ success: true });
    } catch (error) {
      next(error);
    }
  },
};
```

**Routes with Master Guard:**
```typescript
// apps/api/src/routes/campaignMemory.routes.ts
import express from 'express';
import { campaignMemoryController } from '../controllers/campaignMemory.controller';
import { authenticate } from '../middleware/auth.middleware';
import { requireMaster } from '../middleware/subscription.middleware';

const router = express.Router({ mergeParams: true });

router.get('/', authenticate, requireMaster, campaignMemoryController.list);
router.post('/', authenticate, requireMaster, campaignMemoryController.create);
router.patch('/:memoryId', authenticate, requireMaster, campaignMemoryController.update);
router.delete('/:memoryId', authenticate, requireMaster, campaignMemoryController.delete);

export default router;
```

### NPC Generator (Master Tier)
```typescript
// apps/api/src/controllers/npcGenerator.controller.ts
import { Request, Response, NextFunction } from 'express';
import { anthropic } from '../lib/anthropic';

export const npcGeneratorController = {
  async generate(req: Request, res: Response, next: NextFunction) {
    try {
      const { race, characterClass, level, personality } = req.body;

      const systemPrompt = `You are a D&D 5e NPC generator. Generate a complete NPC with stats, backstory, and personality.

**Parameters:**
- Race: ${race || 'Human'}
- Class: ${characterClass || 'Commoner'}
- Level: ${level || 1}
- Personality: ${personality || 'Neutral'}

**Output Format (JSON):**
{
  "name": "NPC name",
  "race": "...",
  "class": "...",
  "level": 1,
  "stats": {
    "STR": 10,
    "DEX": 10,
    "CON": 10,
    "INT": 10,
    "WIS": 10,
    "CHA": 10
  },
  "hp": 10,
  "ac": 10,
  "backstory": "2-3 sentences",
  "personality": "...",
  "motivations": ["...", "..."],
  "secrets": ["..."]
}`;

      const response = await anthropic.messages.create({
        model: 'claude-3-5-sonnet-20241022',
        max_tokens: 1024,
        temperature: 0.8,
        system: systemPrompt,
        messages: [
          {
            role: 'user',
            content: 'Generate the NPC now.',
          },
        ],
      });

      const npcData = JSON.parse(response.content[0].text);

      res.json({ npc: npcData });
    } catch (error) {
      next(error);
    }
  },
};
```

### Testing

**Test scenarios:**
- Free user can create up to 3 characters
- Creating 4th character shows upgrade modal
- Free user can create up to 2 tables
- Creating 3rd table shows upgrade modal
- Premium user can create unlimited characters
- Premium user can create up to 10 tables
- Master user can create unlimited tables
- Free user limited to 3 AI suggestions per combat
- Premium user has unlimited AI suggestions
- Premium badge shown next to premium/master users
- Custom themes locked for free users
- Theme selector disabled for free users
- Campaign memory endpoints require master tier
- NPC generator requires master tier
- Downgraded user gets read-only access to excess resources

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
