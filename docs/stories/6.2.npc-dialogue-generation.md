# Story 6.2: NPC Dialogue Generation

## Status
Draft

## Story
**As a** DM,
**I want** AI to generate NPC dialogue and responses in character,
**so that** I can improvise conversations without breaking immersion.

## Acceptance Criteria
1. DM can create NPC profiles with name, personality, goals, voice
2. "/npc {name} {prompt}" command in chat triggers AI dialogue
3. AI generates response in NPC's voice based on profile + context
4. NPC responses appear as special chat messages with NPC badge
5. NPC profile includes: name, race, personality traits, goals, voice style
6. AI maintains NPC personality across multiple interactions
7. DM can edit NPC profiles after creation
8. NPC responses count toward AI usage limits

## Tasks / Subtasks

- [ ] Create NPC database model (AC: 1, 5)
  - [ ] Fields: id, tableId, name, race, personality, goals, voiceStyle, avatarUrl
  - [ ] Personality: string (e.g., "gruff, loyal, suspicious of magic")
  - [ ] Goals: string (e.g., "protect the village, find lost son")
  - [ ] VoiceStyle: string (e.g., "speaks in short sentences, uses sailor slang")

- [ ] Create NPC management UI (AC: 1, 7)
  - [ ] "NPCs" tab in table page sidebar
  - [ ] List all table NPCs
  - [ ] "Add NPC" button opens modal
  - [ ] Edit button for each NPC
  - [ ] Delete confirmation

- [ ] Build NPC creation form (AC: 1, 5)
  - [ ] Input: name (required)
  - [ ] Input: race (optional, e.g., "Human", "Elf")
  - [ ] Textarea: personality (e.g., "Wise, mysterious, cryptic")
  - [ ] Textarea: goals (e.g., "Guide heroes, protect ancient secrets")
  - [ ] Textarea: voice style (e.g., "Speaks in riddles, uses thee/thou")
  - [ ] Optional: avatar URL

- [ ] Implement /npc chat command (AC: 2)
  - [ ] Parse: `/npc {npcName} {prompt}`
  - [ ] Example: `/npc Gandalf What do you know about the dragon?`
  - [ ] Extract NPC name and prompt
  - [ ] Find NPC in database by name (case-insensitive)
  - [ ] Return error if NPC not found

- [ ] Generate NPC dialogue (AC: 3, 6)
  - [ ] Fetch NPC profile from database
  - [ ] Build context: personality, goals, voice, recent conversation
  - [ ] Call Claude API with NPC-specific system prompt
  - [ ] Streaming response (like DM assistant)
  - [ ] Return dialogue in NPC's voice

- [ ] Create NPC system prompt (AC: 3, 6)
  - [ ] Role: "You are {npcName}, a {race}"
  - [ ] Include personality traits
  - [ ] Include goals/motivations
  - [ ] Include voice style instructions
  - [ ] Example: "Speak in short, gruff sentences. Distrust magic users."

- [ ] Display NPC messages in chat (AC: 4)
  - [ ] Special message card for NPC responses
  - [ ] Show NPC avatar (or placeholder)
  - [ ] Display "NPC" badge
  - [ ] Different styling from player messages
  - [ ] Format: "{npcName}: {dialogue}"

- [ ] Track NPC conversation history (AC: 6)
  - [ ] Store NPC messages in Message table with type="npc"
  - [ ] Include npcId in message metadata
  - [ ] AI context includes last 10 NPC interactions
  - [ ] Maintains personality consistency

- [ ] Create NPC API endpoints (AC: 1, 2, 7)
  - [ ] POST `/api/tables/{tableId}/npcs` - Create NPC
  - [ ] GET `/api/tables/{tableId}/npcs` - List NPCs
  - [ ] PATCH `/api/tables/{tableId}/npcs/{npcId}` - Update NPC
  - [ ] DELETE `/api/tables/{tableId}/npcs/{npcId}` - Delete NPC
  - [ ] POST `/api/tables/{tableId}/npcs/{npcId}/speak` - Generate dialogue

- [ ] Handle AI usage tracking (AC: 8)
  - [ ] Count NPC dialogue requests toward rate limit
  - [ ] Track with type="npc" in AIUsage table
  - [ ] Show combined usage (DM assist + NPC dialogue)

## Dev Notes

### NPC Profile Example
**[Source: PRD Section 3.7.3 - NPC Profiles]**

```typescript
interface NPC {
  id: string;
  tableId: string;
  name: string;
  race?: string;
  personality: string;
  goals: string;
  voiceStyle: string;
  avatarUrl?: string;
  createdAt: Date;
}

// Example NPC
const gandalf: NPC = {
  id: 'clxxx',
  tableId: 'clyyyy',
  name: 'Gandalf',
  race: 'Wizard (Istari)',
  personality: 'Wise, patient, mysterious. Knows more than he reveals. Kind but stern when needed.',
  goals: 'Guide the Fellowship. Defeat Sauron. Protect Middle-earth from darkness.',
  voiceStyle: 'Speaks formally with occasional wit. Uses "my dear" and "fool of a Took". Gives cryptic hints.',
  avatarUrl: 'https://example.com/gandalf.jpg',
  createdAt: new Date(),
};
```

### NPC Dialogue System Prompt
**[Source: AI prompt engineering best practices]**

```typescript
function buildNPCSystemPrompt(npc: NPC, context: {
  recentMessages: Message[];
  partyMembers: string[];
}): string {
  return `You are ${npc.name}${npc.race ? `, a ${npc.race}` : ''}.

**Personality:**
${npc.personality}

**Goals & Motivations:**
${npc.goals}

**Voice & Speaking Style:**
${npc.voiceStyle}

**Current Context:**
You are speaking with: ${context.partyMembers.join(', ')}

Recent conversation:
${context.recentMessages
  .slice(-10)
  .map((m) => `${m.user.username}: ${m.content}`)
  .join('\n')}

**Instructions:**
- Respond in character as ${npc.name}
- Maintain the personality and voice style described above
- Keep responses concise (2-4 sentences)
- React naturally to the party's questions and actions
- Stay true to your goals and motivations
- If asked about something you wouldn't know, respond in character

Respond to the following prompt in character:`;
}
```

### Prisma Schema Updates
**[Source: Architecture Section 4.9 - NPC Model]**

```prisma
model NPC {
  id          String   @id @default(cuid())
  tableId     String
  name        String
  race        String?
  personality String   @db.Text
  goals       String   @db.Text
  voiceStyle  String   @db.Text
  avatarUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  table    Table     @relation(fields: [tableId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([tableId])
  @@unique([tableId, name]) // Unique NPC names per table
}

// Update Message model to support NPC messages
model Message {
  id          String   @id @default(cuid())
  tableId     String
  userId      String
  characterId String?
  npcId       String?  // NEW: Link to NPC for NPC messages
  content     String   @db.Text
  type        String   @default("text") // text, system, roll, npc
  metadata    Json?
  createdAt   DateTime @default(now())

  table     Table      @relation(fields: [tableId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  character Character? @relation(fields: [characterId], references: [id], onDelete: SetNull)
  npc       NPC?       @relation(fields: [npcId], references: [id], onDelete: SetNull)

  @@index([tableId, createdAt])
}
```

### NPC Speak API Endpoint
**[Source: Architecture Section 5.1.9 - NPC Endpoints]**

```typescript
// apps/api/src/controllers/npc.controller.ts
import { generateNPCDialogue } from '@iarpg/ai';

export const npcController = {
  async create(req: Request, res: Response, next: NextFunction) {
    try {
      const { tableId } = req.params;
      const userId = req.user!.id;
      const { name, race, personality, goals, voiceStyle, avatarUrl } = req.body;

      // Verify user is DM
      const table = await prisma.table.findUnique({
        where: { id: tableId },
      });

      if (!table || table.ownerId !== userId) {
        return res.status(403).json({ error: 'Only DM can create NPCs' });
      }

      const npc = await prisma.nPC.create({
        data: {
          tableId,
          name,
          race,
          personality,
          goals,
          voiceStyle,
          avatarUrl,
        },
      });

      res.status(201).json({ npc });
    } catch (error) {
      if (error.code === 'P2002') {
        return res.status(400).json({ error: 'NPC with this name already exists' });
      }
      next(error);
    }
  },

  async speak(req: Request, res: Response, next: NextFunction) {
    try {
      const { tableId, npcId } = req.params;
      const userId = req.user!.id;
      const { prompt } = req.body;

      // Verify user is DM
      const table = await prisma.table.findUnique({
        where: { id: tableId },
      });

      if (!table || table.ownerId !== userId) {
        return res.status(403).json({ error: 'Only DM can trigger NPC dialogue' });
      }

      // Fetch NPC
      const npc = await prisma.nPC.findUnique({
        where: { id: npcId },
      });

      if (!npc) {
        return res.status(404).json({ error: 'NPC not found' });
      }

      // Check rate limit (same as DM assistant)
      const user = await prisma.user.findUnique({
        where: { id: userId },
        select: { tier: true },
      });

      if (user?.tier === 'free') {
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
        const recentUsage = await prisma.aIUsage.count({
          where: {
            userId,
            createdAt: { gte: oneHourAgo },
          },
        });

        if (recentUsage >= 10) {
          return res.status(429).json({ error: 'Rate limit exceeded' });
        }
      }

      // Fetch context
      const recentMessages = await prisma.message.findMany({
        where: { tableId },
        include: { user: { select: { username: true } } },
        orderBy: { createdAt: 'desc' },
        take: 20,
      });

      const partyMembers = await prisma.tableMember.findMany({
        where: { tableId, role: 'player' },
        include: { character: { select: { name: true } } },
      });

      const context = {
        recentMessages: recentMessages.reverse(),
        partyMembers: partyMembers
          .map((m) => m.character?.name)
          .filter(Boolean) as string[],
      };

      // Set up SSE
      res.setHeader('Content-Type', 'text/event-stream');
      res.setHeader('Cache-Control', 'no-cache');
      res.setHeader('Connection', 'keep-alive');

      let fullResponse = '';
      let tokensUsed = 0;

      try {
        const stream = await generateNPCDialogue(npc, prompt, context);

        for await (const chunk of stream) {
          fullResponse += chunk;
          tokensUsed += chunk.split(' ').length;

          res.write(`data: ${JSON.stringify({ chunk })}\n\n`);
        }

        res.write('data: [DONE]\n\n');
        res.end();

        // Save NPC message to chat
        await prisma.message.create({
          data: {
            tableId,
            userId, // DM is the one triggering it
            npcId: npc.id,
            content: fullResponse,
            type: 'npc',
          },
        });

        // Broadcast to table
        req.io.to(`table:${tableId}`).emit('message:new', {
          message: {
            id: Date.now().toString(),
            npcId: npc.id,
            npc: { name: npc.name, avatarUrl: npc.avatarUrl },
            content: fullResponse,
            type: 'npc',
            createdAt: new Date(),
          },
        });

        // Track usage
        const cost = calculateCost(tokensUsed, 'claude-3-5-sonnet-20241022');
        await prisma.aIUsage.create({
          data: {
            userId,
            tableId,
            prompt: `[NPC: ${npc.name}] ${prompt}`,
            response: fullResponse,
            tokensUsed,
            cost,
          },
        });
      } catch (error) {
        res.write(`data: ${JSON.stringify({ error: 'Failed to generate dialogue' })}\n\n`);
        res.end();
      }
    } catch (error) {
      next(error);
    }
  },
};
```

### NPC Dialogue Generation (AI Package)
```typescript
// packages/ai/src/npc.ts
import Anthropic from '@anthropic-ai/sdk';
import { NPC } from '@prisma/client';

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

export async function generateNPCDialogue(
  npc: NPC,
  prompt: string,
  context: {
    recentMessages: Array<{ username: string; content: string }>;
    partyMembers: string[];
  }
): Promise<AsyncIterable<string>> {
  const systemPrompt = buildNPCSystemPrompt(npc, context);

  const stream = await anthropic.messages.stream({
    model: 'claude-3-5-sonnet-20241022',
    max_tokens: 512, // Shorter for NPC dialogue
    temperature: 0.8, // More creative for personality
    system: systemPrompt,
    messages: [
      {
        role: 'user',
        content: prompt,
      },
    ],
  });

  return (async function* () {
    for await (const chunk of stream) {
      if (
        chunk.type === 'content_block_delta' &&
        chunk.delta.type === 'text_delta'
      ) {
        yield chunk.delta.text;
      }
    }
  })();
}

function buildNPCSystemPrompt(npc: NPC, context: any): string {
  return `You are ${npc.name}${npc.race ? `, a ${npc.race}` : ''}.

**Personality:**
${npc.personality}

**Goals & Motivations:**
${npc.goals}

**Voice & Speaking Style:**
${npc.voiceStyle}

**Current Context:**
You are speaking with: ${context.partyMembers.join(', ')}

Recent conversation:
${context.recentMessages
  .slice(-10)
  .map((m) => `${m.username}: ${m.content}`)
  .join('\n')}

**Instructions:**
- Respond in character as ${npc.name}
- Maintain the personality and voice style described above
- Keep responses concise (2-4 sentences max)
- React naturally to questions and actions
- Stay true to your goals and motivations
- If asked about something you wouldn't know, respond in character

Respond to the following prompt in character:`;
}
```

### Chat Command Parser
```typescript
// apps/web/src/lib/chatCommands.ts
export interface NPCCommand {
  type: 'npc';
  npcName: string;
  prompt: string;
}

export function parseChatCommand(content: string): NPCCommand | null {
  // Match: /npc {name} {prompt}
  const npcRegex = /^\/npc\s+(\w+)\s+(.+)$/i;
  const match = content.match(npcRegex);

  if (match) {
    return {
      type: 'npc',
      npcName: match[1],
      prompt: match[2],
    };
  }

  return null;
}
```

### Chat Input with Command Support
```typescript
export function ChatInput({ tableId }: ChatInputProps) {
  const [content, setContent] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!content.trim()) return;

    // Check for commands
    const command = parseChatCommand(content);

    if (command && command.type === 'npc') {
      // Find NPC
      const npcs = await fetchNPCs(tableId);
      const npc = npcs.find(
        (n) => n.name.toLowerCase() === command.npcName.toLowerCase()
      );

      if (!npc) {
        toast.error(`NPC "${command.npcName}" not found`);
        return;
      }

      // Trigger NPC dialogue
      await triggerNPCDialogue(tableId, npc.id, command.prompt);
      setContent('');
      return;
    }

    // Regular message
    await sendMessage(content);
    setContent('');
  };

  return (
    <form onSubmit={handleSubmit}>
      <Textarea
        value={content}
        onChange={(e) => setContent(e.target.value)}
        placeholder="Type a message or /npc {name} {prompt}"
      />
      <Button type="submit">Send</Button>
    </form>
  );
}
```

### NPC Message Component
```typescript
function NPCMessage({ message }: { message: Message }) {
  return (
    <div className="flex gap-3 mb-4">
      <Avatar className="h-10 w-10">
        <AvatarImage src={message.npc?.avatarUrl} />
        <AvatarFallback>{message.npc?.name[0]}</AvatarFallback>
      </Avatar>

      <div className="flex-1">
        <div className="flex items-center gap-2 mb-1">
          <span className="font-medium">{message.npc?.name}</span>
          <Badge variant="outline" className="text-xs border-purple-500 text-purple-500">
            NPC
          </Badge>
          <span className="text-xs text-gray-400">
            {formatTimestamp(message.createdAt)}
          </span>
        </div>

        <div className="p-3 rounded-lg bg-purple-500/10 border border-purple-500/30">
          <p className="italic">{message.content}</p>
        </div>
      </div>
    </div>
  );
}
```

### Testing

**Test scenarios:**
- DM can create NPC with personality and voice
- DM can edit NPC profile
- /npc command triggers dialogue generation
- NPC dialogue matches personality and voice style
- NPC responses appear as special messages in chat
- NPC messages have purple styling and NPC badge
- AI maintains personality across multiple interactions
- NPC dialogue counts toward rate limits
- Non-DMs cannot create or trigger NPCs
- Error shown if NPC name not found
- NPC names are unique per table

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
