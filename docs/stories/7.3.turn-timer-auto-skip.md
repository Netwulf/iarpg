# Story 7.3: Turn Timer & Auto-Skip System

## Status
Draft

## Story
**As a** DM,
**I want** turns to automatically advance when deadlines pass,
**so that** the game doesn't stall waiting for inactive players.

## Acceptance Criteria
1. Background job checks for expired turn deadlines every 5 minutes
2. When deadline passes, player gets 1-hour grace period with warning
3. After grace period, turn automatically skips to next player
4. Skipped turn marked in database (skipped=true)
5. Skipped player receives notification: "You missed your turn"
6. DM receives notification: "{Player} missed their turn"
7. Turn history shows skipped turns with red indicator
8. DM can manually extend deadline before it expires

## Tasks / Subtasks

- [ ] Create deadline checker job (AC: 1)
  - [ ] Background job runs every 5 minutes
  - [ ] Query AsyncTurn where deadline < now AND endedAt = null
  - [ ] For each expired turn, trigger grace period or skip
  - [ ] Use node-cron or BullMQ for scheduling

- [ ] Implement grace period system (AC: 2)
  - [ ] Add gracePeriodStarted field to AsyncTurn
  - [ ] When deadline passes, set gracePeriodStarted = now
  - [ ] Send warning notification to player
  - [ ] Grace period = 1 hour after original deadline
  - [ ] Display "URGENT: 1h remaining!" in UI

- [ ] Auto-skip after grace period (AC: 3, 4)
  - [ ] If gracePeriodStarted + 1h < now, skip turn
  - [ ] Update AsyncTurn: endedAt = now, skipped = true
  - [ ] Advance to next player (create new AsyncTurn)
  - [ ] Log skip event

- [ ] Send skip notifications (AC: 5, 6)
  - [ ] Notify skipped player: "You missed your turn in {table}"
  - [ ] Notify DM: "{Player} missed their turn"
  - [ ] Include link to table
  - [ ] Track skip count per player (optional)

- [ ] Display skipped turns in history (AC: 7)
  - [ ] Show red "SKIPPED" badge
  - [ ] Different styling from normal turns
  - [ ] Tooltip: "Turn deadline expired"

- [ ] Implement deadline extension (AC: 8)
  - [ ] "Extend Deadline" button (DM only)
  - [ ] Modal: "Extend by: 6h, 12h, 24h"
  - [ ] Update AsyncTurn deadline field
  - [ ] Notify player of extension
  - [ ] Broadcast update to table

- [ ] Create deadline extension API (AC: 8)
  - [ ] PATCH `/api/tables/{tableId}/async/turns/{turnId}/extend`
  - [ ] Validate user is DM
  - [ ] Add hours to deadline
  - [ ] Cancel grace period if active
  - [ ] Return updated turn

- [ ] Add grace period UI warning (AC: 2)
  - [ ] Show red banner: "‚ö†Ô∏è GRACE PERIOD: 45m remaining!"
  - [ ] Countdown timer
  - [ ] Pulsing animation
  - [ ] Only visible to current player

- [ ] Track skip statistics (AC: 4)
  - [ ] Count skipped turns per player
  - [ ] Display in user profile (optional)
  - [ ] DM can see skip history per player

- [ ] Handle edge cases
  - [ ] Player posts action during grace period ‚Üí cancel skip
  - [ ] DM ends turn manually during grace period ‚Üí cancel skip
  - [ ] Multiple consecutive skips ‚Üí notify DM (player inactive)

## Dev Notes

### Deadline Checker Job
**[Source: Best practices for background jobs]**

```typescript
// apps/api/src/jobs/deadlineChecker.ts
import cron from 'node-cron';
import { prisma } from '@iarpg/db';
import { notificationService } from '../services/notification.service';

export function startDeadlineChecker() {
  // Run every 5 minutes
  cron.schedule('*/5 * * * *', async () => {
    console.log('Checking for expired turn deadlines...');

    const now = new Date();

    // Find expired turns
    const expiredTurns = await prisma.asyncTurn.findMany({
      where: {
        endedAt: null, // Active turns
        deadline: {
          lt: now, // Deadline has passed
        },
      },
      include: {
        table: {
          select: {
            id: true,
            name: true,
            ownerId: true,
          },
        },
        user: {
          select: {
            id: true,
            username: true,
          },
        },
      },
    });

    for (const turn of expiredTurns) {
      if (!turn.gracePeriodStarted) {
        // Start grace period
        await startGracePeriod(turn);
      } else {
        // Check if grace period expired
        const gracePeriodEnd = new Date(turn.gracePeriodStarted);
        gracePeriodEnd.setHours(gracePeriodEnd.getHours() + 1);

        if (gracePeriodEnd < now) {
          // Skip turn
          await skipTurn(turn);
        }
      }
    }
  });

  console.log('Deadline checker started');
}

async function startGracePeriod(turn: AsyncTurn) {
  console.log(`Starting grace period for turn ${turn.id}`);

  // Update turn
  await prisma.asyncTurn.update({
    where: { id: turn.id },
    data: { gracePeriodStarted: new Date() },
  });

  // Notify player
  await notificationService.notifyGracePeriod(
    turn.userId,
    turn.tableId,
    turn.table.name
  );
}

async function skipTurn(turn: AsyncTurn) {
  console.log(`Skipping turn ${turn.id} for user ${turn.user.username}`);

  // End current turn (mark as skipped)
  await prisma.asyncTurn.update({
    where: { id: turn.id },
    data: {
      endedAt: new Date(),
      skipped: true,
    },
  });

  // Notify skipped player
  await notificationService.notifyTurnSkipped(
    turn.userId,
    turn.tableId,
    turn.table.name
  );

  // Notify DM
  await notificationService.notifyDMPlayerSkipped(
    turn.table.ownerId,
    turn.tableId,
    turn.user.username,
    turn.table.name
  );

  // Advance to next player
  const table = await prisma.table.findUnique({
    where: { id: turn.tableId },
  });

  if (!table) return;

  const turnOrder = table.turnOrder as string[];
  const nextIndex = (table.currentTurnIndex + 1) % turnOrder.length;

  await prisma.table.update({
    where: { id: turn.tableId },
    data: { currentTurnIndex: nextIndex },
  });

  // Create next turn
  const nextUserId = turnOrder[nextIndex];
  const deadline = new Date(
    Date.now() + (table.turnDeadlineHours || 24) * 60 * 60 * 1000
  );

  const nextTurn = await prisma.asyncTurn.create({
    data: {
      tableId: turn.tableId,
      userId: nextUserId,
      deadline,
    },
  });

  // Notify next player
  await notificationService.notifyTurnStart(
    nextUserId,
    turn.tableId,
    deadline
  );

  // Broadcast via Socket.io
  // (Assuming io instance is available globally or via dependency injection)
  // io.to(`table:${turn.tableId}`).emit('async:turn-skipped', { turn, nextTurn });
}
```

### Prisma Schema Update
```prisma
model AsyncTurn {
  id                  String    @id @default(cuid())
  tableId             String
  userId              String
  startedAt           DateTime  @default(now())
  endedAt             DateTime?
  deadline            DateTime
  gracePeriodStarted  DateTime? // NEW: When grace period started
  skipped             Boolean   @default(false) // NEW: True if auto-skipped

  table     Table     @relation(fields: [tableId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([tableId, startedAt])
  @@index([deadline]) // For deadline checker
}
```

### Notification Service Extensions
```typescript
// Add to NotificationService
export class NotificationService {
  // ... existing methods

  async notifyGracePeriod(userId: string, tableId: string, tableName: string) {
    await prisma.notification.create({
      data: {
        userId,
        type: 'turn_warning',
        title: `‚ö†Ô∏è Turn deadline passed - Grace period`,
        message: `Your turn in ${tableName} deadline has passed. You have 1 hour before your turn is skipped.`,
        link: `/tables/${tableId}`,
      },
    });

    // Optional: Send email
    const user = await prisma.user.findUnique({
      where: { id: userId },
      select: { email: true, notificationSettings: true },
    });

    if (user?.email && (user.notificationSettings as any).email) {
      // Send urgent email
    }
  }

  async notifyTurnSkipped(userId: string, tableId: string, tableName: string) {
    await prisma.notification.create({
      data: {
        userId,
        type: 'turn_skipped',
        title: `You missed your turn in ${tableName}`,
        message: `Your turn was automatically skipped due to deadline expiration.`,
        link: `/tables/${tableId}`,
      },
    });
  }

  async notifyDMPlayerSkipped(dmId: string, tableId: string, playerName: string, tableName: string) {
    await prisma.notification.create({
      data: {
        userId: dmId,
        type: 'player_skipped',
        title: `${playerName} missed their turn`,
        message: `${playerName}'s turn in ${tableName} was automatically skipped.`,
        link: `/tables/${tableId}`,
      },
    });
  }
}
```

### Deadline Extension API
```typescript
// apps/api/src/controllers/asyncTurn.controller.ts
export const asyncTurnController = {
  // ... existing methods

  async extendDeadline(req: Request, res: Response, next: NextFunction) {
    try {
      const { tableId, turnId } = req.params;
      const userId = req.user!.id;
      const { hours } = req.body; // 6, 12, 24

      // Verify user is DM
      const table = await prisma.table.findUnique({
        where: { id: tableId },
      });

      if (!table || table.ownerId !== userId) {
        return res.status(403).json({ error: 'Only DM can extend deadlines' });
      }

      // Fetch turn
      const turn = await prisma.asyncTurn.findUnique({
        where: { id: turnId },
        include: {
          user: { select: { username: true } },
        },
      });

      if (!turn) {
        return res.status(404).json({ error: 'Turn not found' });
      }

      // Extend deadline
      const newDeadline = new Date(turn.deadline);
      newDeadline.setHours(newDeadline.getHours() + hours);

      const updated = await prisma.asyncTurn.update({
        where: { id: turnId },
        data: {
          deadline: newDeadline,
          gracePeriodStarted: null, // Cancel grace period if active
        },
      });

      // Notify player
      await notificationService.notifyDeadlineExtended(
        turn.userId,
        tableId,
        hours,
        newDeadline
      );

      // Broadcast update
      req.io.to(`table:${tableId}`).emit('async:deadline-extended', {
        turnId,
        newDeadline,
        hours,
      });

      res.json({ turn: updated });
    } catch (error) {
      next(error);
    }
  },
};
```

### Grace Period Warning Component
```typescript
interface GracePeriodWarningProps {
  turn: AsyncTurn;
}

export function GracePeriodWarning({ turn }: GracePeriodWarningProps) {
  if (!turn.gracePeriodStarted) return null;

  const [timeLeft, setTimeLeft] = useState('');

  useEffect(() => {
    const interval = setInterval(() => {
      const graceEnd = new Date(turn.gracePeriodStarted!);
      graceEnd.setHours(graceEnd.getHours() + 1);

      const now = new Date();
      const diff = graceEnd.getTime() - now.getTime();

      if (diff <= 0) {
        setTimeLeft('Expired');
        return;
      }

      const minutes = Math.floor(diff / (1000 * 60));
      setTimeLeft(`${minutes}m`);
    }, 10000); // Update every 10 seconds

    return () => clearInterval(interval);
  }, [turn.gracePeriodStarted]);

  return (
    <Alert variant="destructive" className="border-red-500 bg-red-500/20 animate-pulse">
      <AlertCircle className="h-4 w-4" />
      <AlertTitle>‚ö†Ô∏è GRACE PERIOD</AlertTitle>
      <AlertDescription>
        Your turn deadline has passed! You have <strong>{timeLeft}</strong> remaining before your turn is automatically skipped.
      </AlertDescription>
    </Alert>
  );
}
```

### Extend Deadline Button (DM)
```typescript
function ExtendDeadlineButton({ tableId, turnId }: { tableId: string; turnId: string }) {
  const [showModal, setShowModal] = useState(false);
  const [hours, setHours] = useState(24);

  const handleExtend = async () => {
    await fetch(`/api/tables/${tableId}/async/turns/${turnId}/extend`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ hours }),
    });

    toast.success(`Deadline extended by ${hours} hours!`);
    setShowModal(false);
  };

  return (
    <>
      <Button variant="outline" size="sm" onClick={() => setShowModal(true)}>
        Extend Deadline
      </Button>

      <Dialog open={showModal} onOpenChange={setShowModal}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Extend Turn Deadline</DialogTitle>
          </DialogHeader>

          <div className="space-y-4">
            <p className="text-sm text-gray-400">
              Give the player more time to post their action.
            </p>

            <div className="flex gap-2">
              {[6, 12, 24, 48].map((h) => (
                <Button
                  key={h}
                  variant={hours === h ? 'default' : 'outline'}
                  onClick={() => setHours(h)}
                >
                  {h}h
                </Button>
              ))}
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setShowModal(false)}>
              Cancel
            </Button>
            <Button onClick={handleExtend}>
              Extend by {hours}h
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  );
}
```

### Skipped Turn Display
```typescript
function TurnHistoryItem({ turn }: { turn: AsyncTurn }) {
  return (
    <div className={`p-3 border-l-4 ${
      turn.skipped ? 'border-red-500 bg-red-500/10' : 'border-gray-800'
    }`}>
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Avatar className="h-8 w-8">
            <AvatarImage src={turn.user.avatar} />
            <AvatarFallback>{turn.user.username[0]}</AvatarFallback>
          </Avatar>
          <span className="font-medium">{turn.user.username}</span>
          {turn.skipped && (
            <Badge variant="destructive" className="text-xs">
              SKIPPED
            </Badge>
          )}
        </div>

        <span className="text-xs text-gray-400">
          {formatDistanceToNow(new Date(turn.startedAt), { addSuffix: true })}
        </span>
      </div>

      {turn.skipped && (
        <p className="text-xs text-red-400 mt-1">
          Turn deadline expired
        </p>
      )}
    </div>
  );
}
```

### Start Background Job on Server Init
```typescript
// apps/api/src/server.ts
import { startDeadlineChecker } from './jobs/deadlineChecker';

// ... existing server setup

// Start background jobs
startDeadlineChecker();

httpServer.listen(PORT, () => {
  logger.info(`üöÄ API server running on port ${PORT}`);
  logger.info(`‚è∞ Deadline checker running`);
});
```

### Testing

**Test scenarios:**
- Background job runs every 5 minutes
- Grace period starts when deadline passes
- Player notified of grace period
- Turn auto-skips after grace period expires
- Skipped player notified
- DM notified of skipped turn
- Skipped turns show in history with red badge
- DM can extend deadline before expiration
- Extension cancels grace period
- Player posting during grace period cancels skip
- Multiple consecutive skips tracked

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
