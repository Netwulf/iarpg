# Story 9.2: PWA Implementation (Progressive Web App)

## Status
Draft

## Story
**As a** mobile user,
**I want** to install IA-RPG as a Progressive Web App,
**so that** I can access it like a native app with offline capabilities.

## Acceptance Criteria
1. Web app manifest configured with app name, icons, theme colors
2. Service worker registered for offline caching
3. "Add to Home Screen" prompt shown on mobile browsers
4. App icons for iOS (120x120, 152x152, 167x167, 180x180) and Android (192x192, 512x512)
5. Splash screens configured for iOS
6. App runs in standalone mode (no browser UI)
7. Service worker caches static assets (JS, CSS, images)
8. PWA installable on Chrome, Safari, Edge

## Tasks / Subtasks

- [ ] Create web app manifest (AC: 1)
  - [ ] Create `public/manifest.json`
  - [ ] Fields: name, short_name, description, start_url, display, theme_color, background_color
  - [ ] Icons array: 192x192, 512x512
  - [ ] Link manifest in `<head>` tag

- [ ] Generate app icons (AC: 4)
  - [ ] Create base icon (1024x1024)
  - [ ] Generate sizes: 192x192, 512x512 (Android)
  - [ ] Generate sizes: 120x120, 152x152, 167x167, 180x180 (iOS)
  - [ ] Save to `public/icons/`
  - [ ] Add apple-touch-icon links

- [ ] Configure iOS splash screens (AC: 5)
  - [ ] Generate splash images for common iOS sizes
  - [ ] Add `<link rel="apple-touch-startup-image">` tags
  - [ ] Set `apple-mobile-web-app-capable` meta tag
  - [ ] Set `apple-mobile-web-app-status-bar-style`

- [ ] Create service worker (AC: 2, 7)
  - [ ] Create `public/sw.js`
  - [ ] Cache static assets on install (JS, CSS, fonts, icons)
  - [ ] Implement cache-first strategy for assets
  - [ ] Implement network-first strategy for API calls
  - [ ] Cache version management

- [ ] Register service worker (AC: 2)
  - [ ] Register in `app/layout.tsx` on mount
  - [ ] Handle service worker updates
  - [ ] Show "Update available" prompt
  - [ ] Skip waiting on update acceptance

- [ ] Implement install prompt (AC: 3)
  - [ ] Listen for `beforeinstallprompt` event
  - [ ] Show custom "Install App" button
  - [ ] Trigger prompt on button click
  - [ ] Hide button after install

- [ ] Configure standalone mode (AC: 6)
  - [ ] Manifest: `display: "standalone"`
  - [ ] Hide browser UI in standalone mode
  - [ ] Detect standalone mode in JS
  - [ ] Show back button if needed

- [ ] Set theme colors (AC: 1)
  - [ ] `theme-color` meta tag: #1a1a1a (dark)
  - [ ] Manifest `theme_color`: #1a1a1a
  - [ ] Manifest `background_color`: #0a0a0a

- [ ] Test PWA on browsers (AC: 8)
  - [ ] Chrome DevTools: Lighthouse PWA audit
  - [ ] Chrome Android: Install and test
  - [ ] Safari iOS: Add to Home Screen and test
  - [ ] Edge Desktop: Install and test
  - [ ] Verify offline functionality

- [ ] Add PWA metadata tags (AC: 1, 5, 6)
  - [ ] `<meta name="application-name">`
  - [ ] `<meta name="apple-mobile-web-app-title">`
  - [ ] `<meta name="apple-mobile-web-app-capable">`
  - [ ] `<meta name="mobile-web-app-capable">`

- [ ] Handle service worker updates (AC: 2)
  - [ ] Detect new service worker available
  - [ ] Show "New version available" toast
  - [ ] "Update Now" button → skip waiting + reload
  - [ ] Auto-update on next visit (optional)

- [ ] Optimize for PWA best practices (AC: 1-8)
  - [ ] HTTPS required (already configured)
  - [ ] Responsive design (Story 9.1)
  - [ ] Fast load time (<3s)
  - [ ] Works offline (basic UI)
  - [ ] Score 90+ on Lighthouse PWA audit

## Dev Notes

### Web App Manifest
**[Source: PWA Manifest Specification]**

```json
// public/manifest.json
{
  "name": "IA-RPG - AI-Powered D&D Platform",
  "short_name": "IA-RPG",
  "description": "Play Dungeons & Dragons online with AI-powered DM assistance",
  "start_url": "/",
  "display": "standalone",
  "theme_color": "#1a1a1a",
  "background_color": "#0a0a0a",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ]
}
```

**Link manifest in layout:**
```tsx
// apps/web/src/app/layout.tsx
export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <head>
        <link rel="manifest" href="/manifest.json" />
        <meta name="theme-color" content="#1a1a1a" />

        {/* PWA Meta Tags */}
        <meta name="application-name" content="IA-RPG" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="apple-mobile-web-app-title" content="IA-RPG" />
        <meta name="mobile-web-app-capable" content="yes" />

        {/* Apple Touch Icons */}
        <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png" />
        <link rel="apple-touch-icon" sizes="167x167" href="/icons/apple-touch-icon-167x167.png" />
        <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-touch-icon-152x152.png" />
        <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-touch-icon-120x120.png" />

        {/* iOS Splash Screens */}
        <link
          rel="apple-touch-startup-image"
          media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
          href="/splash/iPhone_15_Pro_Max__iPhone_15_Plus__iPhone_14_Pro_Max_portrait.png"
        />
        <link
          rel="apple-touch-startup-image"
          media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
          href="/splash/iPhone_15_Pro__iPhone_15__iPhone_14_Pro_portrait.png"
        />
        {/* Add more splash screens for other iOS devices */}
      </head>
      <body>{children}</body>
    </html>
  );
}
```

### Service Worker
**[Source: Workbox for Next.js PWA]**

```bash
pnpm add next-pwa
pnpm add -D workbox-webpack-plugin
```

**Configure next-pwa:**
```javascript
// next.config.js
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development',
  runtimeCaching: [
    {
      urlPattern: /^https:\/\/api\.iarpg\.com\/.*$/,
      handler: 'NetworkFirst',
      options: {
        cacheName: 'api-cache',
        expiration: {
          maxEntries: 100,
          maxAgeSeconds: 24 * 60 * 60, // 24 hours
        },
        networkTimeoutSeconds: 10,
      },
    },
    {
      urlPattern: /\.(?:png|jpg|jpeg|svg|gif|webp)$/,
      handler: 'CacheFirst',
      options: {
        cacheName: 'image-cache',
        expiration: {
          maxEntries: 200,
          maxAgeSeconds: 30 * 24 * 60 * 60, // 30 days
        },
      },
    },
    {
      urlPattern: /\.(?:js|css)$/,
      handler: 'StaleWhileRevalidate',
      options: {
        cacheName: 'static-cache',
        expiration: {
          maxEntries: 100,
          maxAgeSeconds: 7 * 24 * 60 * 60, // 7 days
        },
      },
    },
  ],
});

module.exports = withPWA({
  // Your existing Next.js config
});
```

**Manual Service Worker (Alternative):**
```javascript
// public/sw.js
const CACHE_NAME = 'iarpg-v1.0.0';
const STATIC_ASSETS = [
  '/',
  '/dashboard',
  '/characters',
  '/tables',
  '/dice',
  '/manifest.json',
  '/icons/icon-192x192.png',
  '/icons/icon-512x512.png',
];

// Install: Cache static assets
self.addEventListener('install', (event) => {
  console.log('Service Worker: Installing...');
  event.waitUntil(
    caches.open(CACHE_NAME).then((cache) => {
      console.log('Service Worker: Caching static assets');
      return cache.addAll(STATIC_ASSETS);
    })
  );
  self.skipWaiting();
});

// Activate: Clean up old caches
self.addEventListener('activate', (event) => {
  console.log('Service Worker: Activating...');
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames
          .filter((name) => name !== CACHE_NAME)
          .map((name) => caches.delete(name))
      );
    })
  );
  self.clients.claim();
});

// Fetch: Cache-first for static, network-first for API
self.addEventListener('fetch', (event) => {
  const { request } = event;
  const url = new URL(request.url);

  // API calls: Network-first
  if (url.pathname.startsWith('/api/')) {
    event.respondWith(
      fetch(request)
        .then((response) => {
          // Clone and cache the response
          const responseClone = response.clone();
          caches.open(CACHE_NAME).then((cache) => {
            cache.put(request, responseClone);
          });
          return response;
        })
        .catch(() => caches.match(request))
    );
    return;
  }

  // Static assets: Cache-first
  event.respondWith(
    caches.match(request).then((cachedResponse) => {
      if (cachedResponse) {
        return cachedResponse;
      }

      return fetch(request).then((response) => {
        // Cache new assets
        if (request.method === 'GET' && response.status === 200) {
          const responseClone = response.clone();
          caches.open(CACHE_NAME).then((cache) => {
            cache.put(request, responseClone);
          });
        }
        return response;
      });
    })
  );
});
```

### Service Worker Registration
```typescript
// apps/web/src/components/ServiceWorkerRegistration.tsx
'use client';

import { useEffect, useState } from 'react';
import { toast } from 'sonner';

export function ServiceWorkerRegistration() {
  const [waitingWorker, setWaitingWorker] = useState<ServiceWorker | null>(null);

  useEffect(() => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker
        .register('/sw.js')
        .then((registration) => {
          console.log('Service Worker registered:', registration);

          // Check for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;

            if (newWorker) {
              newWorker.addEventListener('statechange', () => {
                if (
                  newWorker.state === 'installed' &&
                  navigator.serviceWorker.controller
                ) {
                  // New service worker available
                  setWaitingWorker(newWorker);
                  toast.info('New version available!', {
                    action: {
                      label: 'Update Now',
                      onClick: () => {
                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                        window.location.reload();
                      },
                    },
                    duration: Infinity,
                  });
                }
              });
            }
          });
        })
        .catch((error) => {
          console.error('Service Worker registration failed:', error);
        });

      // Listen for controller change (new SW activated)
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    }
  }, []);

  return null;
}
```

**Add to layout:**
```tsx
// apps/web/src/app/layout.tsx
import { ServiceWorkerRegistration } from '@/components/ServiceWorkerRegistration';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body>
        {children}
        <ServiceWorkerRegistration />
      </body>
    </html>
  );
}
```

### Install Prompt
```typescript
// apps/web/src/components/InstallPrompt.tsx
'use client';

import { useEffect, useState } from 'react';
import { Button } from '@/components/ui/button';
import { X, Download } from 'lucide-react';

interface BeforeInstallPromptEvent extends Event {
  prompt: () => Promise<void>;
  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;
}

export function InstallPrompt() {
  const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null);
  const [showPrompt, setShowPrompt] = useState(false);

  useEffect(() => {
    const handler = (e: Event) => {
      e.preventDefault();
      setDeferredPrompt(e as BeforeInstallPromptEvent);
      setShowPrompt(true);
    };

    window.addEventListener('beforeinstallprompt', handler);

    // Check if already installed
    if (window.matchMedia('(display-mode: standalone)').matches) {
      setShowPrompt(false);
    }

    return () => window.removeEventListener('beforeinstallprompt', handler);
  }, []);

  const handleInstall = async () => {
    if (!deferredPrompt) return;

    deferredPrompt.prompt();

    const { outcome } = await deferredPrompt.userChoice;

    if (outcome === 'accepted') {
      console.log('User accepted the install prompt');
    }

    setDeferredPrompt(null);
    setShowPrompt(false);
  };

  if (!showPrompt) return null;

  return (
    <div className="fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-lg z-50">
      <button
        onClick={() => setShowPrompt(false)}
        className="absolute top-2 right-2 text-gray-400 hover:text-white"
      >
        <X className="w-5 h-5" />
      </button>

      <div className="flex items-start gap-3 mb-3">
        <div className="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
          <Download className="w-6 h-6" />
        </div>
        <div>
          <h3 className="font-bold mb-1">Install IA-RPG</h3>
          <p className="text-sm text-gray-400">
            Install our app for a better experience and offline access.
          </p>
        </div>
      </div>

      <Button onClick={handleInstall} className="w-full">
        Install App
      </Button>
    </div>
  );
}
```

**Add to layout:**
```tsx
import { InstallPrompt } from '@/components/InstallPrompt';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body>
        {children}
        <InstallPrompt />
      </body>
    </html>
  );
}
```

### iOS Splash Screen Generator
**Use PWA Asset Generator:**

```bash
npx pwa-asset-generator public/icons/icon-512x512.png public/splash --splash-only --background "#0a0a0a" --type png
```

This generates splash screens for all iOS device sizes and outputs the HTML tags to copy into your `<head>`.

### Detecting Standalone Mode
```typescript
// apps/web/src/utils/pwa.ts
export function isStandalone(): boolean {
  if (typeof window === 'undefined') return false;

  // iOS Safari
  if ((window.navigator as any).standalone === true) {
    return true;
  }

  // Android Chrome, Edge, etc.
  if (window.matchMedia('(display-mode: standalone)').matches) {
    return true;
  }

  return false;
}

export function isPWA(): boolean {
  return isStandalone();
}
```

**Usage:**
```typescript
'use client';

import { useEffect, useState } from 'react';
import { isPWA } from '@/utils/pwa';

export function PWABackButton() {
  const [showBackButton, setShowBackButton] = useState(false);

  useEffect(() => {
    setShowBackButton(isPWA());
  }, []);

  if (!showBackButton) return null;

  return (
    <button onClick={() => window.history.back()}>
      ← Back
    </button>
  );
}
```

### Lighthouse PWA Audit Checklist
**[Source: Lighthouse PWA Audit Requirements]**

- ✅ **Installable:** Web app manifest with name, icons, start_url, display
- ✅ **Service Worker:** Registered and caching assets
- ✅ **HTTPS:** Served over secure connection
- ✅ **Responsive:** Works on mobile, tablet, desktop
- ✅ **Fast Load:** First Contentful Paint < 3s
- ✅ **Works Offline:** Service worker responds to fetch events
- ✅ **Themed:** `theme-color` meta tag
- ✅ **Viewport:** Viewport meta tag configured
- ✅ **Apple Touch Icon:** iOS icons configured

**Run audit:**
```bash
# Chrome DevTools → Lighthouse → Run PWA audit
# Or via CLI:
npm install -g lighthouse
lighthouse https://yourdomain.com --view --preset=pwa
```

### Testing PWA Installation

**Chrome Android:**
1. Visit site on Chrome Android
2. Tap menu (⋮) → "Install app" or "Add to Home Screen"
3. Confirm installation
4. App appears on home screen
5. Launch app → runs in standalone mode

**Safari iOS:**
1. Visit site on Safari iOS
2. Tap Share button → "Add to Home Screen"
3. Confirm
4. App appears on home screen
5. Launch app → runs in standalone mode

**Edge Desktop:**
1. Visit site on Edge
2. Click install icon in address bar
3. Confirm
4. App opens in standalone window
5. App appears in Start Menu

### Environment Variables
```bash
# .env.production
NEXT_PUBLIC_PWA_ENABLED=true
```

### Testing

**Test scenarios:**
- Manifest.json accessible at /manifest.json
- Manifest includes all required fields
- App icons display correctly in browser
- Service worker registers successfully
- Static assets cached after first load
- App works offline (shows cached pages)
- "Add to Home Screen" prompt appears on mobile
- Install prompt can be dismissed and triggered again
- App installs successfully on Chrome Android
- App installs successfully on Safari iOS
- App runs in standalone mode (no browser UI)
- Theme color applies to browser UI
- iOS splash screens display correctly
- Service worker updates when new version deployed
- "Update available" toast shows for new versions
- Lighthouse PWA audit scores 90+
- App icons display correctly on home screen
- Uninstalling app removes cached data

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
