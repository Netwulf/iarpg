# Story 8.1: Stripe Integration & Subscription Tiers

## Status
Draft

## Story
**As a** player,
**I want** to subscribe to premium tiers via Stripe,
**so that** I can unlock advanced features and support the platform.

## Acceptance Criteria
1. Three subscription tiers: Free, Premium ($9.99/month), Master ($19.99/month)
2. Stripe Checkout integration for subscription signup
3. User redirected to Stripe Checkout when upgrading
4. Webhook handler processes subscription events (created, updated, canceled)
5. User tier field updated in database after successful payment
6. User can view current subscription status in Account Settings
7. User can manage subscription (upgrade, downgrade, cancel) via Stripe portal
8. Free trial: 14 days for Premium tier
9. Canceled subscriptions retain access until period end

## Tasks / Subtasks

- [ ] Install Stripe SDK (AC: 1, 2)
  - [ ] `pnpm add stripe @stripe/stripe-js` in api + web
  - [ ] Add `STRIPE_SECRET_KEY` to .env (backend)
  - [ ] Add `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` to .env (frontend)
  - [ ] Create Stripe client instances

- [ ] Update User model for subscriptions (AC: 1, 5)
  - [ ] Add `tier` field: free, premium, master (default: free)
  - [ ] Add `stripeCustomerId` field (nullable)
  - [ ] Add `stripeSubscriptionId` field (nullable)
  - [ ] Add `subscriptionStatus` field (active, canceled, past_due, trialing)
  - [ ] Add `subscriptionPeriodEnd` field (nullable DateTime)
  - [ ] Run migration: `prisma migrate dev`

- [ ] Create Stripe products and prices (AC: 1)
  - [ ] Stripe Dashboard: Create "Premium" product ($9.99/month)
  - [ ] Stripe Dashboard: Create "Master" product ($19.99/month)
  - [ ] Add price IDs to .env: `STRIPE_PREMIUM_PRICE_ID`, `STRIPE_MASTER_PRICE_ID`
  - [ ] Document product IDs in README

- [ ] Build Stripe checkout session endpoint (AC: 2, 3, 8)
  - [ ] POST `/api/billing/checkout`
  - [ ] Accepts `tier: premium | master` in request body
  - [ ] Creates Stripe customer if not exists
  - [ ] Creates Stripe checkout session with trial_period_days=14
  - [ ] Returns `sessionId` and `url` for redirect
  - [ ] Metadata: userId, tier

- [ ] Create checkout page UI (AC: 3)
  - [ ] "Upgrade" button in Account Settings
  - [ ] Pricing cards show $9.99/month (Premium), $19.99/month (Master)
  - [ ] "Start Free Trial" CTA (14 days)
  - [ ] Click button → call checkout endpoint → redirect to Stripe
  - [ ] Success redirect: `/account/subscription?success=true`
  - [ ] Cancel redirect: `/account/subscription?canceled=true`

- [ ] Implement Stripe webhook handler (AC: 4, 5, 9)
  - [ ] POST `/api/billing/webhook`
  - [ ] Verify Stripe signature (`stripe.webhooks.constructEvent`)
  - [ ] Handle `checkout.session.completed` → update tier to premium/master
  - [ ] Handle `customer.subscription.updated` → update status
  - [ ] Handle `customer.subscription.deleted` → mark as canceled, keep access until period_end
  - [ ] Handle `invoice.payment_failed` → mark as past_due

- [ ] Create subscription status service (AC: 5)
  - [ ] Function `updateUserTier(userId, tier, subscriptionData)`
  - [ ] Updates User model: tier, stripeSubscriptionId, subscriptionStatus
  - [ ] Sets subscriptionPeriodEnd from Stripe `current_period_end`
  - [ ] Logs subscription change
  - [ ] Returns updated user

- [ ] Build subscription management page (AC: 6, 7)
  - [ ] Page: `/account/subscription`
  - [ ] Show current tier, status, period end date
  - [ ] "Manage Subscription" button → redirects to Stripe Customer Portal
  - [ ] Stripe portal allows upgrade, downgrade, cancel
  - [ ] Show success/canceled messages from query params

- [ ] Create customer portal session endpoint (AC: 7)
  - [ ] POST `/api/billing/portal`
  - [ ] Fetches user's stripeCustomerId
  - [ ] Creates Stripe billing portal session
  - [ ] Return URL: `/account/subscription`
  - [ ] Returns portal URL for redirect

- [ ] Configure Stripe webhook in Dashboard (AC: 4)
  - [ ] Add endpoint: `https://yourdomain.com/api/billing/webhook`
  - [ ] Select events: checkout.session.completed, customer.subscription.*
  - [ ] Copy webhook signing secret to .env: `STRIPE_WEBHOOK_SECRET`

- [ ] Handle canceled subscriptions (AC: 9)
  - [ ] On `customer.subscription.deleted`, set status = 'canceled'
  - [ ] Keep tier as premium/master until subscriptionPeriodEnd
  - [ ] Background job checks expired subscriptions daily
  - [ ] Downgrade to free when subscriptionPeriodEnd < now

- [ ] Add subscription guards (AC: 1)
  - [ ] Middleware: `requirePremium()` checks tier = premium || master
  - [ ] Middleware: `requireMaster()` checks tier = master
  - [ ] Apply to premium endpoints (e.g., unlimited AI)

- [ ] Create pricing page (AC: 1, 8)
  - [ ] Page: `/pricing`
  - [ ] 3-column pricing table (Free, Premium, Master)
  - [ ] Feature comparison list
  - [ ] "14-day free trial" badge on Premium
  - [ ] CTAs: "Get Started" (free), "Start Free Trial" (premium/master)

- [ ] Test subscription flow (AC: 1-9)
  - [ ] Test checkout with test card (4242 4242 4242 4242)
  - [ ] Verify webhook triggers and updates tier
  - [ ] Test subscription cancellation
  - [ ] Test trial period expiration
  - [ ] Test upgrade from premium to master
  - [ ] Test downgrade from master to premium

## Dev Notes

### Stripe SDK Setup
**[Source: Stripe Node.js SDK documentation]**

```bash
# Install dependencies
pnpm add stripe @stripe/stripe-js
```

**Backend (apps/api):**
```typescript
// apps/api/src/lib/stripe.ts
import Stripe from 'stripe';

if (!process.env.STRIPE_SECRET_KEY) {
  throw new Error('STRIPE_SECRET_KEY is required');
}

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
  apiVersion: '2024-11-20.acacia',
  typescript: true,
});
```

**Frontend (apps/web):**
```typescript
// apps/web/src/lib/stripe.ts
import { loadStripe } from '@stripe/stripe-js';

if (!process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY) {
  throw new Error('NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY is required');
}

export const stripePromise = loadStripe(
  process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
);
```

### Prisma Schema Update
```prisma
model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  username              String    @unique
  passwordHash          String?
  avatar                String?
  tier                  String    @default("free") // free, premium, master
  stripeCustomerId      String?   @unique
  stripeSubscriptionId  String?   @unique
  subscriptionStatus    String?   // active, canceled, past_due, trialing
  subscriptionPeriodEnd DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  characters  Character[]
  tables      Table[]
  aiUsage     AIUsage[]

  @@index([tier])
  @@index([stripeCustomerId])
}
```

**Migration:**
```bash
npx prisma migrate dev --name add_subscription_fields
```

### Stripe Checkout Endpoint
**[Source: Stripe Checkout Session API]**

```typescript
// apps/api/src/controllers/billing.controller.ts
import { Request, Response, NextFunction } from 'express';
import { stripe } from '../lib/stripe';
import { prisma } from '@iarpg/db';

export const billingController = {
  async createCheckoutSession(req: Request, res: Response, next: NextFunction) {
    try {
      const userId = req.user!.id;
      const { tier } = req.body; // 'premium' or 'master'

      if (!['premium', 'master'].includes(tier)) {
        return res.status(400).json({ error: 'Invalid tier' });
      }

      const user = await prisma.user.findUnique({
        where: { id: userId },
      });

      if (!user) {
        return res.status(404).json({ error: 'User not found' });
      }

      // Create or retrieve Stripe customer
      let stripeCustomerId = user.stripeCustomerId;

      if (!stripeCustomerId) {
        const customer = await stripe.customers.create({
          email: user.email,
          metadata: {
            userId: user.id,
          },
        });

        stripeCustomerId = customer.id;

        await prisma.user.update({
          where: { id: userId },
          data: { stripeCustomerId },
        });
      }

      // Get price ID from env
      const priceId =
        tier === 'premium'
          ? process.env.STRIPE_PREMIUM_PRICE_ID
          : process.env.STRIPE_MASTER_PRICE_ID;

      if (!priceId) {
        return res.status(500).json({ error: 'Price ID not configured' });
      }

      // Create checkout session
      const session = await stripe.checkout.sessions.create({
        customer: stripeCustomerId,
        mode: 'subscription',
        payment_method_types: ['card'],
        line_items: [
          {
            price: priceId,
            quantity: 1,
          },
        ],
        subscription_data: {
          trial_period_days: 14, // 14-day free trial
          metadata: {
            userId: user.id,
            tier,
          },
        },
        success_url: `${process.env.FRONTEND_URL}/account/subscription?success=true`,
        cancel_url: `${process.env.FRONTEND_URL}/account/subscription?canceled=true`,
        metadata: {
          userId: user.id,
          tier,
        },
      });

      res.json({ sessionId: session.id, url: session.url });
    } catch (error) {
      next(error);
    }
  },

  async createPortalSession(req: Request, res: Response, next: NextFunction) {
    try {
      const userId = req.user!.id;

      const user = await prisma.user.findUnique({
        where: { id: userId },
      });

      if (!user?.stripeCustomerId) {
        return res.status(400).json({ error: 'No subscription found' });
      }

      const session = await stripe.billingPortal.sessions.create({
        customer: user.stripeCustomerId,
        return_url: `${process.env.FRONTEND_URL}/account/subscription`,
      });

      res.json({ url: session.url });
    } catch (error) {
      next(error);
    }
  },

  async handleWebhook(req: Request, res: Response, next: NextFunction) {
    const sig = req.headers['stripe-signature'];

    if (!sig) {
      return res.status(400).send('No signature');
    }

    let event: Stripe.Event;

    try {
      event = stripe.webhooks.constructEvent(
        req.body,
        sig,
        process.env.STRIPE_WEBHOOK_SECRET!
      );
    } catch (err: any) {
      console.error('Webhook signature verification failed:', err.message);
      return res.status(400).send(`Webhook Error: ${err.message}`);
    }

    try {
      switch (event.type) {
        case 'checkout.session.completed': {
          const session = event.data.object as Stripe.Checkout.Session;
          const userId = session.metadata?.userId;
          const tier = session.metadata?.tier;

          if (!userId || !tier) {
            console.error('Missing metadata in checkout session');
            break;
          }

          await prisma.user.update({
            where: { id: userId },
            data: {
              tier,
              stripeSubscriptionId: session.subscription as string,
              subscriptionStatus: 'trialing', // Starts in trial
            },
          });

          console.log(`User ${userId} upgraded to ${tier} (trial)`);
          break;
        }

        case 'customer.subscription.updated': {
          const subscription = event.data.object as Stripe.Subscription;
          const userId = subscription.metadata?.userId;

          if (!userId) {
            console.error('Missing userId in subscription metadata');
            break;
          }

          await prisma.user.update({
            where: { id: userId },
            data: {
              subscriptionStatus: subscription.status,
              subscriptionPeriodEnd: new Date(subscription.current_period_end * 1000),
            },
          });

          console.log(`Subscription updated for user ${userId}: ${subscription.status}`);
          break;
        }

        case 'customer.subscription.deleted': {
          const subscription = event.data.object as Stripe.Subscription;
          const userId = subscription.metadata?.userId;

          if (!userId) {
            console.error('Missing userId in subscription metadata');
            break;
          }

          // Mark as canceled, but keep tier until period end
          await prisma.user.update({
            where: { id: userId },
            data: {
              subscriptionStatus: 'canceled',
              subscriptionPeriodEnd: new Date(subscription.current_period_end * 1000),
            },
          });

          console.log(`Subscription canceled for user ${userId}, access until ${new Date(subscription.current_period_end * 1000)}`);
          break;
        }

        case 'invoice.payment_failed': {
          const invoice = event.data.object as Stripe.Invoice;
          const subscription = invoice.subscription as string;

          const user = await prisma.user.findFirst({
            where: { stripeSubscriptionId: subscription },
          });

          if (user) {
            await prisma.user.update({
              where: { id: user.id },
              data: { subscriptionStatus: 'past_due' },
            });

            console.log(`Payment failed for user ${user.id}`);
          }
          break;
        }

        default:
          console.log(`Unhandled event type: ${event.type}`);
      }

      res.json({ received: true });
    } catch (error) {
      console.error('Webhook handler error:', error);
      next(error);
    }
  },
};
```

### Billing Routes
```typescript
// apps/api/src/routes/billing.routes.ts
import express from 'express';
import { billingController } from '../controllers/billing.controller';
import { authenticate } from '../middleware/auth.middleware';

const router = express.Router();

// Checkout session (requires auth)
router.post('/checkout', authenticate, billingController.createCheckoutSession);

// Customer portal (requires auth)
router.post('/portal', authenticate, billingController.createPortalSession);

// Stripe webhook (no auth, verified by signature)
router.post(
  '/webhook',
  express.raw({ type: 'application/json' }), // IMPORTANT: raw body for signature verification
  billingController.handleWebhook
);

export default router;
```

**Register routes in main app:**
```typescript
// apps/api/src/server.ts
import billingRoutes from './routes/billing.routes';

// IMPORTANT: Webhook route must use raw body
app.use('/api/billing/webhook', billingRoutes);

// Other routes use JSON parser
app.use(express.json());
app.use('/api/billing', billingRoutes);
```

### Pricing Page Component
**[Source: Front-End Spec Section 5.8 - Pricing & Billing]**

```typescript
// apps/web/src/app/pricing/page.tsx
'use client';

import { useState } from 'react';
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Check } from 'lucide-react';
import { stripePromise } from '@/lib/stripe';

const tiers = [
  {
    name: 'Free',
    price: '$0',
    description: 'Get started with basic features',
    features: [
      '3 characters',
      '2 active tables',
      '3 AI suggestions per combat',
      'Basic dice rolling',
      'Community support',
    ],
    cta: 'Get Started',
    tier: 'free',
  },
  {
    name: 'Premium',
    price: '$9.99',
    description: 'For regular players',
    features: [
      'Unlimited characters',
      '10 active tables',
      'Unlimited AI suggestions',
      'Advanced dice macros',
      'Priority support',
      'Custom character themes',
    ],
    cta: 'Start Free Trial',
    tier: 'premium',
    popular: true,
    trial: '14-day free trial',
  },
  {
    name: 'Master',
    price: '$19.99',
    description: 'For Dungeon Masters',
    features: [
      'Everything in Premium',
      'Unlimited tables as DM',
      'Advanced AI DM assistant',
      'Campaign management tools',
      'Custom NPC generator',
      'White-label option',
    ],
    cta: 'Start Free Trial',
    tier: 'master',
    trial: '14-day free trial',
  },
];

export default function PricingPage() {
  const [loading, setLoading] = useState<string | null>(null);

  const handleCheckout = async (tier: string) => {
    if (tier === 'free') {
      window.location.href = '/signup';
      return;
    }

    setLoading(tier);

    try {
      const response = await fetch('/api/billing/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tier }),
      });

      const { url } = await response.json();

      if (url) {
        window.location.href = url;
      }
    } catch (error) {
      console.error('Checkout error:', error);
    } finally {
      setLoading(null);
    }
  };

  return (
    <div className="container mx-auto px-4 py-16">
      <div className="text-center mb-12">
        <h1 className="text-4xl font-bold mb-4">Choose Your Plan</h1>
        <p className="text-xl text-gray-400">
          Start with a 14-day free trial. Cancel anytime.
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
        {tiers.map((tier) => (
          <Card
            key={tier.tier}
            className={tier.popular ? 'border-blue-500 border-2 relative' : ''}
          >
            {tier.popular && (
              <Badge className="absolute -top-3 left-1/2 -translate-x-1/2 bg-blue-500">
                Most Popular
              </Badge>
            )}

            <CardHeader>
              <CardTitle className="text-2xl">{tier.name}</CardTitle>
              <CardDescription>{tier.description}</CardDescription>
              <div className="mt-4">
                <span className="text-4xl font-bold">{tier.price}</span>
                {tier.price !== '$0' && (
                  <span className="text-gray-400">/month</span>
                )}
              </div>
              {tier.trial && (
                <Badge variant="outline" className="mt-2 w-fit">
                  {tier.trial}
                </Badge>
              )}
            </CardHeader>

            <CardContent>
              <ul className="space-y-3">
                {tier.features.map((feature) => (
                  <li key={feature} className="flex items-start gap-2">
                    <Check className="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" />
                    <span className="text-sm">{feature}</span>
                  </li>
                ))}
              </ul>
            </CardContent>

            <CardFooter>
              <Button
                className="w-full"
                variant={tier.popular ? 'default' : 'outline'}
                onClick={() => handleCheckout(tier.tier)}
                disabled={loading === tier.tier}
              >
                {loading === tier.tier ? 'Loading...' : tier.cta}
              </Button>
            </CardFooter>
          </Card>
        ))}
      </div>
    </div>
  );
}
```

### Subscription Management Page
```typescript
// apps/web/src/app/account/subscription/page.tsx
'use client';

import { useEffect, useState } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { formatDistanceToNow } from 'date-fns';
import { useSearchParams } from 'next/navigation';
import { toast } from 'sonner';

interface Subscription {
  tier: string;
  status: string;
  periodEnd: string | null;
}

export default function SubscriptionPage() {
  const [subscription, setSubscription] = useState<Subscription | null>(null);
  const [loading, setLoading] = useState(false);
  const searchParams = useSearchParams();

  useEffect(() => {
    if (searchParams.get('success')) {
      toast.success('Subscription activated! Enjoy your 14-day free trial.');
    } else if (searchParams.get('canceled')) {
      toast.error('Subscription checkout was canceled.');
    }

    fetchSubscription();
  }, []);

  const fetchSubscription = async () => {
    const response = await fetch('/api/users/me');
    const user = await response.json();

    setSubscription({
      tier: user.tier,
      status: user.subscriptionStatus || 'active',
      periodEnd: user.subscriptionPeriodEnd,
    });
  };

  const handleManageSubscription = async () => {
    setLoading(true);

    try {
      const response = await fetch('/api/billing/portal', {
        method: 'POST',
      });

      const { url } = await response.json();

      if (url) {
        window.location.href = url;
      }
    } catch (error) {
      toast.error('Failed to open billing portal');
    } finally {
      setLoading(false);
    }
  };

  if (!subscription) {
    return <div>Loading...</div>;
  }

  return (
    <div className="container mx-auto px-4 py-8 max-w-2xl">
      <h1 className="text-3xl font-bold mb-6">Subscription</h1>

      <Card>
        <CardHeader>
          <CardTitle>Current Plan</CardTitle>
          <CardDescription>Manage your subscription and billing</CardDescription>
        </CardHeader>

        <CardContent className="space-y-4">
          <div className="flex items-center justify-between">
            <span className="text-sm text-gray-400">Tier</span>
            <Badge variant="default" className="capitalize">
              {subscription.tier}
            </Badge>
          </div>

          <div className="flex items-center justify-between">
            <span className="text-sm text-gray-400">Status</span>
            <Badge
              variant={
                subscription.status === 'active' || subscription.status === 'trialing'
                  ? 'default'
                  : 'destructive'
              }
              className="capitalize"
            >
              {subscription.status}
            </Badge>
          </div>

          {subscription.periodEnd && (
            <div className="flex items-center justify-between">
              <span className="text-sm text-gray-400">
                {subscription.status === 'canceled' ? 'Access until' : 'Renews'}
              </span>
              <span className="text-sm">
                {formatDistanceToNow(new Date(subscription.periodEnd), {
                  addSuffix: true,
                })}
              </span>
            </div>
          )}

          {subscription.tier !== 'free' && (
            <Button
              className="w-full mt-4"
              onClick={handleManageSubscription}
              disabled={loading}
            >
              {loading ? 'Loading...' : 'Manage Subscription'}
            </Button>
          )}

          {subscription.tier === 'free' && (
            <Button
              className="w-full mt-4"
              onClick={() => (window.location.href = '/pricing')}
            >
              Upgrade to Premium
            </Button>
          )}
        </CardContent>
      </Card>

      <Card className="mt-6">
        <CardHeader>
          <CardTitle>Plan Features</CardTitle>
        </CardHeader>
        <CardContent>
          {subscription.tier === 'free' && (
            <ul className="space-y-2 text-sm">
              <li>✅ 3 characters</li>
              <li>✅ 2 active tables</li>
              <li>✅ 3 AI suggestions per combat</li>
              <li>❌ Unlimited AI</li>
              <li>❌ Advanced features</li>
            </ul>
          )}

          {subscription.tier === 'premium' && (
            <ul className="space-y-2 text-sm">
              <li>✅ Unlimited characters</li>
              <li>✅ 10 active tables</li>
              <li>✅ Unlimited AI suggestions</li>
              <li>✅ Priority support</li>
              <li>✅ Custom themes</li>
            </ul>
          )}

          {subscription.tier === 'master' && (
            <ul className="space-y-2 text-sm">
              <li>✅ Everything in Premium</li>
              <li>✅ Unlimited DM tables</li>
              <li>✅ Advanced AI DM assistant</li>
              <li>✅ Campaign management</li>
              <li>✅ White-label option</li>
            </ul>
          )}
        </CardContent>
      </Card>
    </div>
  );
}
```

### Subscription Guards Middleware
```typescript
// apps/api/src/middleware/subscription.middleware.ts
import { Request, Response, NextFunction } from 'express';
import { prisma } from '@iarpg/db';

export async function requirePremium(req: Request, res: Response, next: NextFunction) {
  const userId = req.user!.id;

  const user = await prisma.user.findUnique({
    where: { id: userId },
    select: { tier: true },
  });

  if (!user || (user.tier !== 'premium' && user.tier !== 'master')) {
    return res.status(403).json({
      error: 'Premium subscription required',
      upgrade: true,
    });
  }

  next();
}

export async function requireMaster(req: Request, res: Response, next: NextFunction) {
  const userId = req.user!.id;

  const user = await prisma.user.findUnique({
    where: { id: userId },
    select: { tier: true },
  });

  if (!user || user.tier !== 'master') {
    return res.status(403).json({
      error: 'Master subscription required',
      upgrade: true,
    });
  }

  next();
}

export async function checkSubscriptionExpiry(req: Request, res: Response, next: NextFunction) {
  const userId = req.user!.id;

  const user = await prisma.user.findUnique({
    where: { id: userId },
    select: {
      tier: true,
      subscriptionStatus: true,
      subscriptionPeriodEnd: true,
    },
  });

  if (!user) {
    return next();
  }

  // If subscription canceled and period ended, downgrade to free
  if (
    user.subscriptionStatus === 'canceled' &&
    user.subscriptionPeriodEnd &&
    new Date(user.subscriptionPeriodEnd) < new Date()
  ) {
    await prisma.user.update({
      where: { id: userId },
      data: {
        tier: 'free',
        subscriptionStatus: null,
        subscriptionPeriodEnd: null,
      },
    });

    // Attach downgrade flag to request
    (req as any).wasDowngraded = true;
  }

  next();
}
```

**Usage:**
```typescript
// Apply premium guard to unlimited AI endpoint
router.post(
  '/api/tables/:tableId/dm-assist',
  authenticate,
  requirePremium,
  dmAssistController.generateResponse
);
```

### Background Job for Subscription Expiry
```typescript
// apps/api/src/jobs/subscriptionExpiry.ts
import cron from 'node-cron';
import { prisma } from '@iarpg/db';

export function startSubscriptionExpiryChecker() {
  // Run daily at 2 AM
  cron.schedule('0 2 * * *', async () => {
    console.log('Checking for expired subscriptions...');

    const now = new Date();

    const expiredUsers = await prisma.user.findMany({
      where: {
        subscriptionStatus: 'canceled',
        subscriptionPeriodEnd: {
          lt: now,
        },
        tier: {
          in: ['premium', 'master'],
        },
      },
    });

    for (const user of expiredUsers) {
      console.log(`Downgrading user ${user.id} to free tier`);

      await prisma.user.update({
        where: { id: user.id },
        data: {
          tier: 'free',
          subscriptionStatus: null,
          subscriptionPeriodEnd: null,
        },
      });
    }

    console.log(`Downgraded ${expiredUsers.length} users to free tier`);
  });

  console.log('Subscription expiry checker started');
}
```

**Start job in server.ts:**
```typescript
// apps/api/src/server.ts
import { startSubscriptionExpiryChecker } from './jobs/subscriptionExpiry';

startSubscriptionExpiryChecker();
```

### Environment Variables
```bash
# .env (backend)
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PREMIUM_PRICE_ID=price_...
STRIPE_MASTER_PRICE_ID=price_...

# .env.local (frontend)
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
```

### Testing

**Test scenarios:**
- User can view pricing page with 3 tiers
- Free tier shows "Get Started" CTA
- Premium/Master show "Start Free Trial" CTA
- Clicking "Start Free Trial" creates Stripe checkout session
- Redirects to Stripe Checkout page
- Test card (4242 4242 4242 4242) completes checkout
- Webhook receives `checkout.session.completed` event
- User tier updated to premium/master
- User redirected to /account/subscription?success=true
- Subscription status shows "trialing" for 14 days
- After 14 days, status changes to "active"
- User can click "Manage Subscription" → redirects to Stripe portal
- User can cancel subscription in portal
- Webhook receives `customer.subscription.deleted`
- User tier remains premium/master until period end
- Background job downgrades to free after period end
- User can upgrade from premium to master
- User can downgrade from master to premium

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
