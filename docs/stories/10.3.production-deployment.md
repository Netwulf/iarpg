# Story 10.3: Production Deployment & CI/CD

## Status
Draft

## Story
**As a** development team,
**I want** automated CI/CD pipeline and production deployment,
**so that** we can deploy updates safely and efficiently.

## Acceptance Criteria
1. GitHub Actions workflow runs on every push: lint, test, build
2. Automated database migrations run on deployment
3. Environment variables managed securely (GitHub Secrets, Vercel)
4. Production deployment to Vercel (frontend) and Railway/Render (backend)
5. Staging environment mirrors production
6. Docker containers for backend API (optional)
7. Database hosted on Supabase or PostgreSQL cloud service
8. Zero-downtime deployments with health checks

## Tasks / Subtasks

- [ ] Create GitHub Actions workflow (AC: 1)
  - [ ] File: `.github/workflows/ci.yml`
  - [ ] Jobs: lint, typecheck, test, build
  - [ ] Trigger: on push to main, pull requests
  - [ ] Cache dependencies for faster runs

- [ ] Configure linting in CI (AC: 1)
  - [ ] Run `pnpm lint` in workflow
  - [ ] Fail build if linting errors
  - [ ] Cache ESLint results

- [ ] Configure testing in CI (AC: 1)
  - [ ] Run `pnpm test` in workflow
  - [ ] Generate coverage report
  - [ ] Upload coverage to Codecov (optional)

- [ ] Configure build in CI (AC: 1)
  - [ ] Build frontend: `pnpm --filter web build`
  - [ ] Build backend: `pnpm --filter api build`
  - [ ] Fail if build errors

- [ ] Set up Vercel deployment (AC: 4)
  - [ ] Link GitHub repo to Vercel
  - [ ] Configure build settings for Next.js
  - [ ] Set environment variables in Vercel
  - [ ] Enable preview deployments for PRs

- [ ] Set up backend deployment (AC: 4)
  - [ ] Choose platform: Railway, Render, or DigitalOcean
  - [ ] Configure Dockerfile for API
  - [ ] Set environment variables in platform
  - [ ] Enable auto-deploy from GitHub

- [ ] Create Dockerfile for backend (AC: 6)
  - [ ] Base image: node:20-alpine
  - [ ] Install dependencies
  - [ ] Build application
  - [ ] Run Prisma migrations
  - [ ] Start server

- [ ] Configure database hosting (AC: 7)
  - [ ] Set up Supabase project (or PostgreSQL on Railway/Render)
  - [ ] Get connection string
  - [ ] Configure DATABASE_URL in environments
  - [ ] Enable connection pooling

- [ ] Set up automated migrations (AC: 2)
  - [ ] Add migration script to package.json
  - [ ] Run `prisma migrate deploy` on deployment
  - [ ] Rollback strategy for failed migrations

- [ ] Create staging environment (AC: 5)
  - [ ] Staging branch: `staging`
  - [ ] Deploy to staging URL
  - [ ] Separate database for staging
  - [ ] Test changes before production

- [ ] Configure environment variables (AC: 3)
  - [ ] Store secrets in GitHub Secrets
  - [ ] Configure in Vercel dashboard
  - [ ] Configure in backend platform
  - [ ] Document required variables in README

- [ ] Implement health check for deployments (AC: 8)
  - [ ] Deployment waits for /api/health to return 200
  - [ ] Rollback if health check fails
  - [ ] Configure timeout: 60 seconds

- [ ] Set up domain and SSL (AC: 4)
  - [ ] Configure custom domain in Vercel
  - [ ] Configure custom domain for API
  - [ ] Enable HTTPS (automatic on Vercel)
  - [ ] Configure CORS for production domain

- [ ] Create deployment documentation (AC: 4)
  - [ ] README: deployment instructions
  - [ ] Environment variables list
  - [ ] Troubleshooting guide
  - [ ] Rollback procedure

- [ ] Test deployment pipeline (AC: 1-8)
  - [ ] Push to staging, verify deployment
  - [ ] Run migrations on staging
  - [ ] Push to main, verify production deployment
  - [ ] Test rollback procedure
  - [ ] Verify zero-downtime deployment

## Dev Notes

### GitHub Actions CI Workflow
**[Source: GitHub Actions for monorepo with pnpm]**

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm lint

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript check
        run: pnpm typecheck

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: always()

  build:
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Build frontend
        run: pnpm --filter web build

      - name: Build backend
        run: pnpm --filter api build
```

### Dockerfile for Backend API
**[Source: Docker best practices for Node.js]**

```dockerfile
# apps/api/Dockerfile
FROM node:20-alpine AS base

# Install pnpm
RUN npm install -g pnpm

# ---- Dependencies ----
FROM base AS dependencies
WORKDIR /app

# Copy workspace files
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./
COPY packages ./packages
COPY apps/api ./apps/api

# Install dependencies
RUN pnpm install --frozen-lockfile

# ---- Build ----
FROM dependencies AS build
WORKDIR /app

# Generate Prisma client
RUN pnpm --filter @iarpg/db prisma generate

# Build API
RUN pnpm --filter api build

# ---- Production ----
FROM node:20-alpine AS production
WORKDIR /app

# Install pnpm
RUN npm install -g pnpm

# Copy necessary files
COPY --from=build /app/node_modules ./node_modules
COPY --from=build /app/apps/api/dist ./apps/api/dist
COPY --from=build /app/apps/api/package.json ./apps/api/package.json
COPY --from=build /app/packages/db ./packages/db

# Environment
ENV NODE_ENV=production
ENV PORT=3001

EXPOSE 3001

# Run migrations and start server
CMD ["sh", "-c", "cd packages/db && pnpm prisma migrate deploy && cd ../../apps/api && node dist/server.js"]
```

**.dockerignore:**
```
node_modules
dist
.env
.env.local
*.log
.git
.github
```

### Vercel Configuration
**[Source: Vercel Next.js deployment]**

```json
// vercel.json
{
  "buildCommand": "pnpm --filter web build",
  "devCommand": "pnpm --filter web dev",
  "installCommand": "pnpm install",
  "framework": "nextjs",
  "outputDirectory": "apps/web/.next",
  "env": {
    "NEXT_PUBLIC_API_URL": "@api_url",
    "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY": "@stripe_publishable_key",
    "NEXT_PUBLIC_GA_ID": "@ga_id"
  }
}
```

**Steps:**
1. Go to vercel.com → Import Project
2. Connect GitHub repository
3. Select `apps/web` as root directory
4. Set build command: `cd ../.. && pnpm --filter web build`
5. Set output directory: `apps/web/.next`
6. Add environment variables in Vercel dashboard
7. Deploy

### Railway Deployment
**[Source: Railway.app deployment guide]**

```toml
# railway.toml
[build]
builder = "DOCKERFILE"
dockerfilePath = "apps/api/Dockerfile"

[deploy]
healthcheckPath = "/api/health"
healthcheckTimeout = 60
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3
```

**Steps:**
1. Go to railway.app → New Project → Deploy from GitHub
2. Select repository and `apps/api` directory
3. Add PostgreSQL service
4. Set environment variables:
   - DATABASE_URL (from PostgreSQL service)
   - JWT_SECRET
   - STRIPE_SECRET_KEY
   - etc.
5. Deploy

### Environment Variables Documentation
```markdown
# Environment Variables

## Backend (.env)

### Required
- `DATABASE_URL` - PostgreSQL connection string
- `JWT_SECRET` - Secret for JWT signing (min 32 chars)
- `FRONTEND_URL` - Frontend URL for CORS

### Optional
- `STRIPE_SECRET_KEY` - Stripe API key
- `STRIPE_WEBHOOK_SECRET` - Stripe webhook secret
- `ANTHROPIC_API_KEY` - Claude API key
- `SENTRY_DSN` - Sentry error tracking DSN
- `ADMIN_EMAIL` - Admin email for notifications

## Frontend (.env.local)

### Required
- `NEXT_PUBLIC_API_URL` - Backend API URL

### Optional
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` - Stripe publishable key
- `NEXT_PUBLIC_GA_ID` - Google Analytics ID
- `NEXT_PUBLIC_SENTRY_DSN` - Sentry DSN
```

### Automated Migrations
```json
// package.json (in apps/api)
{
  "scripts": {
    "migrate:deploy": "prisma migrate deploy",
    "postinstall": "prisma generate"
  }
}
```

**In Dockerfile:**
```dockerfile
CMD ["sh", "-c", "pnpm migrate:deploy && node dist/server.js"]
```

### Staging Environment Setup
**GitHub branches:**
- `main` → Production
- `staging` → Staging

**Vercel:**
- Production: main branch → iarpg.com
- Preview: staging branch → staging.iarpg.com

**Railway:**
- Production: main branch
- Staging: staging branch (separate project)

**Database:**
- Production: Supabase production DB
- Staging: Supabase staging DB

### Zero-Downtime Deployment
**Health check configuration:**

```typescript
// apps/api/src/controllers/health.controller.ts (updated)
export const healthController = {
  async check(req: Request, res: Response) {
    const healthStatus: any = {
      status: 'healthy',
      timestamp: new Date().toISOString(),
    };

    try {
      // Quick database check (timeout 5s)
      await Promise.race([
        prisma.$queryRaw`SELECT 1`,
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error('Timeout')), 5000)
        ),
      ]);

      healthStatus.database = 'connected';
    } catch (error) {
      healthStatus.status = 'unhealthy';
      healthStatus.database = 'disconnected';
    }

    const statusCode = healthStatus.status === 'healthy' ? 200 : 503;
    res.status(statusCode).json(healthStatus);
  },
};
```

**Railway configuration:**
- Health check path: `/api/health`
- Health check timeout: 60s
- Deployment strategy: Rolling (gradual)

### Rollback Procedure
**Vercel:**
1. Go to Deployments tab
2. Find previous successful deployment
3. Click "Promote to Production"

**Railway:**
1. Go to Deployments tab
2. Click on previous deployment
3. Click "Redeploy"

**Database migrations:**
```bash
# Rollback last migration
pnpm prisma migrate resolve --rolled-back <migration-name>
```

### Domain Configuration
**Vercel:**
1. Go to Project Settings → Domains
2. Add custom domain: `iarpg.com`
3. Configure DNS (A/CNAME records)
4. SSL automatically provisioned

**API Domain (Railway):**
1. Go to Settings → Domains
2. Add custom domain: `api.iarpg.com`
3. Configure DNS CNAME: `api.iarpg.com → railway.app`

**CORS Configuration:**
```typescript
// apps/api/src/server.ts
import cors from 'cors';

const allowedOrigins = [
  process.env.FRONTEND_URL,
  'https://iarpg.com',
  'https://www.iarpg.com',
];

app.use(
  cors({
    origin: (origin, callback) => {
      if (!origin || allowedOrigins.includes(origin)) {
        callback(null, true);
      } else {
        callback(new Error('Not allowed by CORS'));
      }
    },
    credentials: true,
  })
);
```

### Deployment Checklist
```markdown
## Pre-Deployment Checklist

- [ ] All tests passing locally
- [ ] Database migrations tested on staging
- [ ] Environment variables configured
- [ ] Build succeeds locally
- [ ] Security audit passed (pnpm audit)
- [ ] Performance tested (Lighthouse)
- [ ] Error tracking configured (Sentry)
- [ ] Analytics configured (GA4)
- [ ] Health check endpoint working
- [ ] Backup database before production migration

## Post-Deployment Checklist

- [ ] Health check returns 200
- [ ] Frontend loads without errors
- [ ] User can login
- [ ] User can create character
- [ ] User can join table
- [ ] WebSocket connection works
- [ ] Dice roller works
- [ ] AI features work
- [ ] Stripe integration works
- [ ] Error tracking receiving events
- [ ] Analytics receiving events
```

### Monitoring Post-Deployment
```bash
# Check deployment status
curl https://api.iarpg.com/api/health

# Monitor logs
railway logs --tail 100

# Check uptime
curl https://api.uptimerobot.com/v2/getMonitors
```

### Testing

**Test scenarios:**
- Push to staging branch triggers staging deployment
- Push to main branch triggers production deployment
- CI fails if linting errors exist
- CI fails if tests fail
- CI fails if build errors exist
- Migrations run automatically on deployment
- Health check endpoint accessible
- Frontend deployed to Vercel
- Backend deployed to Railway
- Environment variables loaded correctly
- Custom domain resolves correctly
- SSL certificate active
- CORS allows frontend domain
- Rollback restores previous version
- Zero-downtime deployment verified

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
