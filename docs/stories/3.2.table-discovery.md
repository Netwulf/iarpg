# Story 3.2: Table Discovery (Browse/Search)

## Status
Draft

## Story
**As a** User,
**I want** to browse and search for public RPG tables using filters (play style, tags, activity),
**so that** I can discover games that match my preferences and join new adventures.

## Acceptance Criteria
1. Table browser page is accessible at `/tables/browse`
2. Page displays public tables in Netflix-style grid layout (3-4 per row on desktop)
3. Each table card shows name, description, play style, player count, tags, last activity
4. User can filter tables by play style (sync/async/solo)
5. User can search tables by name or description (debounced search)
6. User can filter by tags (multi-select)
7. Results update in real-time as filters change (no page reload)
8. Empty state shows when no tables match filters

## Tasks / Subtasks

- [ ] Create table browser page (AC: 1)
  - [ ] Create `/tables/browse` route
  - [ ] Add "Browse Tables" link in main navigation
  - [ ] Create page layout with filters sidebar + results grid
  - [ ] Add page heading: "Discover Tables"

- [ ] Create table card component (AC: 3)
  - [ ] Display table name (h3)
  - [ ] Display description (truncate to 150 chars)
  - [ ] Display play style badge (sync/async/solo)
  - [ ] Display player count: "3/6 players"
  - [ ] Display tags as small badges (max 3 visible)
  - [ ] Display last activity: "Active 2h ago"
  - [ ] Add "View Table" button
  - [ ] Add hover effect (green neon border)

- [ ] Implement grid layout (AC: 2)
  - [ ] Use CSS Grid: 3-4 columns on desktop, 2 on tablet, 1 on mobile
  - [ ] Add loading skeleton cards during fetch
  - [ ] Implement infinite scroll or pagination (start with pagination)
  - [ ] Show 12 tables per page

- [ ] Create filters sidebar (AC: 4, 5, 6)
  - [ ] Add "Play Style" filter (checkboxes: Sync, Async, Solo)
  - [ ] Add search input (debounced 300ms)
  - [ ] Add "Tags" multi-select dropdown
  - [ ] Add "Clear Filters" button
  - [ ] Show active filter count badge

- [ ] Implement play style filter (AC: 4)
  - [ ] Checkbox group for sync/async/solo
  - [ ] Allow multiple selections (OR logic)
  - [ ] Update URL query params when changed
  - [ ] Apply filter to API request

- [ ] Implement search functionality (AC: 5)
  - [ ] Text input with magnifying glass icon
  - [ ] Debounce input (300ms delay)
  - [ ] Search in table name and description
  - [ ] Update URL query params
  - [ ] Show "Searching..." indicator

- [ ] Implement tag filter (AC: 6)
  - [ ] Fetch available tags from API (GET `/api/tags`)
  - [ ] Display as multi-select dropdown
  - [ ] Allow selecting multiple tags (AND logic)
  - [ ] Show selected tags as removable badges
  - [ ] Update URL query params

- [ ] Create table discovery API endpoint (AC: 2-7)
  - [ ] GET `/api/tables` with query params
  - [ ] Filter by privacy: only "public" and "spectator" tables
  - [ ] Filter by playStyle (array)
  - [ ] Filter by tags (array)
  - [ ] Search by name/description (case-insensitive)
  - [ ] Sort by lastActivityAt (most recent first)
  - [ ] Paginate results (limit, offset)
  - [ ] Return total count for pagination

- [ ] Handle real-time filter updates (AC: 7)
  - [ ] Use React state for filter values
  - [ ] Use useEffect to trigger API calls on filter change
  - [ ] Debounce search input (300ms)
  - [ ] Show loading state during fetch
  - [ ] Update URL with query params (for sharing/bookmarking)

- [ ] Implement empty state (AC: 8)
  - [ ] Show when `tables.length === 0`
  - [ ] Display message: "No tables found"
  - [ ] Show active filters summary
  - [ ] Add "Clear Filters" button
  - [ ] Suggest creating a table if no results

- [ ] Add pagination controls (AC: 2)
  - [ ] Display "Page X of Y"
  - [ ] Add "Previous" and "Next" buttons
  - [ ] Disable buttons at boundaries (first/last page)
  - [ ] Update URL with page number
  - [ ] Scroll to top on page change

- [ ] Make browser responsive (AC: 2)
  - [ ] Mobile (<640px): Filters collapse to dropdown, 1 table per row
  - [ ] Tablet (640-1024px): Filters as sidebar, 2 tables per row
  - [ ] Desktop (>1024px): Filters as sidebar, 3-4 tables per row
  - [ ] Use TailwindCSS responsive classes

## Dev Notes

### Table Browser Layout
**[Source: PRD Section 3.4.1 - Table Discovery Wireframe]**

```
┌─────────────────────────────────────────────┐
│ HEADER: Discover Tables                    │
│ [Search: "dragon campaign"]          [+New] │
└─────────────────────────────────────────────┘

SIDEBAR (Filters)          GRID (Results)

┌─────────────────┐  ┌──────────┐┌──────────┐┌──────────┐
│ Play Style      │  │  Table 1 ││  Table 2 ││  Table 3 │
│ [x] Sync        │  │ Lost...  ││ Curse... ││ Waterd...│
│ [x] Async       │  │ Async    ││ Sync     ││ Async    │
│ [ ] Solo        │  │ 3/6 play ││ 5/6 play ││ 2/8 play │
│                 │  │ [5e][beg]││ [homebr] ││ [5e]     │
│ Tags            │  │ Active 2h││ Active 5h││ Active 1d│
│ [v] Select...   │  │ [View]   ││ [View]   ││ [View]   │
│ [5e]       [x]  │  └──────────┘└──────────┘└──────────┘
│                 │  ┌──────────┐┌──────────┐┌──────────┐
│ [Clear Filters] │  │  Table 4 ││  Table 5 ││  Table 6 │
└─────────────────┘  │ Storm... ││ Out of...││ Hoard... │
                      │ Solo     ││ Async    ││ Sync     │
                      │ 1/1 play ││ 4/6 play ││ 6/6 play │
                      │ [AI-DM]  ││ [5e][new]││ [5e][ful]│
                      │ Active 3h││ Active 1d││ Active 4h│
                      │ [View]   ││ [View]   ││ [View]   │
                      └──────────┘└──────────┘└──────────┘

                      [< Previous]  Page 1 of 3  [Next >]
```

### API Endpoint
**[Source: Architecture Section 5.1.4 - Table Endpoints]**

```typescript
GET /api/tables

Query Params:
- playStyle: string[] (e.g., ["async", "sync"])
- tags: string[] (e.g., ["5e", "beginner-friendly"])
- search: string (e.g., "dragon")
- page: number (default: 1)
- limit: number (default: 12)

Response 200:
{
  tables: [
    {
      id: "clxxx1",
      name: "Lost Mines of Phandelver",
      description: "Classic D&D 5e starter adventure for new players",
      playStyle: "async",
      privacy: "public",
      playerCount: 3,
      maxPlayers: 6,
      tags: ["5e", "beginner-friendly", "official-adventure"],
      lastActivityAt: "2025-09-30T10:30:00Z",
      owner: {
        username: "alice_dm",
        avatar: "https://..."
      }
    },
    // ... more tables
  ],
  pagination: {
    total: 42,
    page: 1,
    limit: 12,
    totalPages: 4
  }
}
```

### Table Card Component
**[Source: Front-End Spec Section 6.4 - Card Components]**

```typescript
interface TableCardProps {
  table: {
    id: string;
    name: string;
    description: string;
    playStyle: 'sync' | 'async' | 'solo';
    playerCount: number;
    maxPlayers: number;
    tags: string[];
    lastActivityAt: string;
    owner: {
      username: string;
      avatar?: string;
    };
  };
}

function TableCard({ table }: TableCardProps) {
  const timeAgo = formatDistanceToNow(new Date(table.lastActivityAt), {
    addSuffix: true,
  });

  return (
    <Card className="p-4 hover:border-green-neon transition-colors cursor-pointer">
      <div className="flex items-start justify-between mb-2">
        <h3 className="text-h4 font-bold truncate flex-1">{table.name}</h3>
        <Badge variant={getBadgeVariant(table.playStyle)}>
          {table.playStyle}
        </Badge>
      </div>

      <p className="text-small text-gray-400 mb-3 line-clamp-2">
        {table.description}
      </p>

      <div className="flex items-center gap-2 mb-3">
        <Avatar className="h-6 w-6">
          <AvatarImage src={table.owner.avatar} />
          <AvatarFallback>{table.owner.username[0]}</AvatarFallback>
        </Avatar>
        <span className="text-small text-gray-400">
          {table.owner.username}
        </span>
      </div>

      <div className="flex items-center gap-2 mb-3">
        <span className="text-small text-gray-400">
          {table.playerCount}/{table.maxPlayers} players
        </span>
        <span className="text-small text-gray-400">•</span>
        <span className="text-small text-gray-400">Active {timeAgo}</span>
      </div>

      <div className="flex flex-wrap gap-1 mb-4">
        {table.tags.slice(0, 3).map((tag) => (
          <Badge key={tag} variant="outline" className="text-xs">
            {tag}
          </Badge>
        ))}
        {table.tags.length > 3 && (
          <Badge variant="outline" className="text-xs">
            +{table.tags.length - 3}
          </Badge>
        )}
      </div>

      <Button asChild className="w-full">
        <Link href={`/tables/${table.id}`}>View Table</Link>
      </Button>
    </Card>
  );
}
```

### Filter Sidebar Component
```typescript
interface FilterSidebarProps {
  filters: {
    playStyle: string[];
    tags: string[];
    search: string;
  };
  onFilterChange: (filters: Partial<FilterState>) => void;
  availableTags: string[];
}

function FilterSidebar({ filters, onFilterChange, availableTags }: FilterSidebarProps) {
  return (
    <aside className="w-64 p-4 border-r border-gray-800">
      <h2 className="text-h4 font-bold mb-4">Filters</h2>

      {/* Search */}
      <div className="mb-6">
        <Label htmlFor="search">Search</Label>
        <Input
          id="search"
          type="text"
          placeholder="Search tables..."
          value={filters.search}
          onChange={(e) => onFilterChange({ search: e.target.value })}
          className="mt-2"
        />
      </div>

      {/* Play Style */}
      <div className="mb-6">
        <Label>Play Style</Label>
        <div className="mt-2 space-y-2">
          {['sync', 'async', 'solo'].map((style) => (
            <div key={style} className="flex items-center">
              <Checkbox
                id={`style-${style}`}
                checked={filters.playStyle.includes(style)}
                onCheckedChange={(checked) => {
                  const newStyles = checked
                    ? [...filters.playStyle, style]
                    : filters.playStyle.filter((s) => s !== style);
                  onFilterChange({ playStyle: newStyles });
                }}
              />
              <label
                htmlFor={`style-${style}`}
                className="ml-2 text-small capitalize cursor-pointer"
              >
                {style}
              </label>
            </div>
          ))}
        </div>
      </div>

      {/* Tags */}
      <div className="mb-6">
        <Label>Tags</Label>
        <MultiSelect
          options={availableTags.map((tag) => ({ label: tag, value: tag }))}
          value={filters.tags}
          onChange={(tags) => onFilterChange({ tags })}
          placeholder="Select tags..."
          className="mt-2"
        />
      </div>

      {/* Clear Filters */}
      <Button
        variant="outline"
        className="w-full"
        onClick={() => onFilterChange({ playStyle: [], tags: [], search: '' })}
      >
        Clear Filters
      </Button>
    </aside>
  );
}
```

### API Controller
**[Source: Architecture Section 5.1.4]**

```typescript
// apps/api/src/controllers/tables.controller.ts
export const tablesController = {
  async list(req: Request, res: Response, next: NextFunction) {
    try {
      const {
        playStyle,
        tags,
        search,
        page = 1,
        limit = 12,
      } = req.query;

      const where: any = {
        privacy: { in: ['public', 'spectator'] },
        state: { in: ['setup', 'active'] }, // Hide completed tables
      };

      // Filter by play style
      if (playStyle) {
        const styles = Array.isArray(playStyle) ? playStyle : [playStyle];
        where.playStyle = { in: styles };
      }

      // Filter by tags (AND logic: table must have all tags)
      if (tags) {
        const tagArray = Array.isArray(tags) ? tags : [tags];
        where.tags = { hasEvery: tagArray };
      }

      // Search in name and description
      if (search) {
        where.OR = [
          { name: { contains: search as string, mode: 'insensitive' } },
          { description: { contains: search as string, mode: 'insensitive' } },
        ];
      }

      // Pagination
      const skip = (Number(page) - 1) * Number(limit);
      const take = Number(limit);

      // Fetch tables
      const [tables, total] = await Promise.all([
        prisma.table.findMany({
          where,
          include: {
            owner: {
              select: {
                username: true,
                avatar: true,
              },
            },
            members: {
              select: { id: true },
            },
          },
          orderBy: { lastActivityAt: 'desc' },
          skip,
          take,
        }),
        prisma.table.count({ where }),
      ]);

      // Transform data
      const tablesWithPlayerCount = tables.map((table) => ({
        id: table.id,
        name: table.name,
        description: table.description,
        playStyle: table.playStyle,
        privacy: table.privacy,
        playerCount: table.members.length,
        maxPlayers: table.maxPlayers,
        tags: table.tags,
        lastActivityAt: table.lastActivityAt,
        owner: table.owner,
      }));

      res.json({
        tables: tablesWithPlayerCount,
        pagination: {
          total,
          page: Number(page),
          limit: Number(limit),
          totalPages: Math.ceil(total / Number(limit)),
        },
      });
    } catch (error) {
      next(error);
    }
  },
};
```

### Debounced Search Hook
**[Source: Best practices for search inputs]**

```typescript
function useDebounce<T>(value: T, delay: number): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]);

  return debouncedValue;
}

// Usage in TableBrowser component
function TableBrowser() {
  const [search, setSearch] = useState('');
  const debouncedSearch = useDebounce(search, 300);

  useEffect(() => {
    fetchTables({ search: debouncedSearch, ...otherFilters });
  }, [debouncedSearch]);

  return (
    <Input
      value={search}
      onChange={(e) => setSearch(e.target.value)}
      placeholder="Search tables..."
    />
  );
}
```

### Empty State Component
```typescript
function EmptyState({ filters }: { filters: FilterState }) {
  const hasFilters = filters.playStyle.length > 0 || filters.tags.length > 0 || filters.search;

  return (
    <div className="flex flex-col items-center justify-center min-h-[400px] text-center">
      <div className="text-6xl mb-4">🔍</div>
      <h2 className="text-h2 font-bold mb-2">No tables found</h2>
      {hasFilters ? (
        <>
          <p className="text-body text-gray-400 mb-2">
            No tables match your current filters.
          </p>
          <p className="text-small text-gray-400 mb-6">
            Try adjusting your search or clearing some filters.
          </p>
          <Button onClick={() => clearFilters()}>Clear Filters</Button>
        </>
      ) : (
        <>
          <p className="text-body text-gray-400 mb-6">
            There are no public tables at the moment. Be the first to create one!
          </p>
          <Button asChild>
            <Link href="/tables/new">Create Table</Link>
          </Button>
        </>
      )}
    </div>
  );
}
```

### Responsive Grid Layout
**[Source: Front-End Spec Section 9 - Responsiveness]**

```tsx
<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
  {tables.map((table) => (
    <TableCard key={table.id} table={table} />
  ))}
</div>
```

### URL Query Params Management
```typescript
// Update URL without page reload
function updateFilters(newFilters: Partial<FilterState>) {
  setFilters({ ...filters, ...newFilters });

  const params = new URLSearchParams();
  if (newFilters.search) params.set('search', newFilters.search);
  if (newFilters.playStyle?.length) params.set('playStyle', newFilters.playStyle.join(','));
  if (newFilters.tags?.length) params.set('tags', newFilters.tags.join(','));

  router.push(`/tables/browse?${params.toString()}`, { scroll: false });
}

// Read filters from URL on page load
useEffect(() => {
  const params = new URLSearchParams(window.location.search);
  setFilters({
    search: params.get('search') || '',
    playStyle: params.get('playStyle')?.split(',') || [],
    tags: params.get('tags')?.split(',') || [],
  });
}, []);
```

### Testing

**Test scenarios:**
- Table browser displays public tables correctly
- Filter by play style updates results
- Search filters tables by name and description
- Tag filter applies AND logic (all tags must match)
- Debounced search reduces API calls
- Empty state shows when no results
- Pagination works correctly
- URL updates with filter changes
- Responsive layout works on mobile, tablet, desktop
- Loading states display during API calls
- "Clear Filters" resets all filters

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
