# Story 1.4: Backend API Foundation (Express + Socket.io)

## Status
Draft

## Story
**As a** Developer,
**I want** to set up the Express.js backend server with Socket.io, middleware, error handling, and basic API structure,
**so that** the backend is ready to implement feature-specific endpoints and realtime functionality.

## Acceptance Criteria
1. Express.js server is running on port 3001 with TypeScript
2. Socket.io server is configured and integrated with Express
3. Core middleware is installed (CORS, body-parser, morgan logging, error handling)
4. Environment configuration is loaded from `.env`
5. Basic health check endpoint `/api/health` returns 200 OK
6. Error handling middleware catches and formats errors consistently
7. Server can be started with `pnpm dev` in apps/api workspace
8. CORS is configured to allow requests from Next.js frontend (localhost:3000)

## Tasks / Subtasks

- [ ] Set up Express.js server (AC: 1)
  - [ ] Install dependencies: `express`, `cors`, `morgan`, `dotenv`
  - [ ] Install dev dependencies: `@types/express`, `@types/cors`, `@types/morgan`, `tsx`, `nodemon`
  - [ ] Create `apps/api/src/server.ts` entry point
  - [ ] Create HTTP server with Express app
  - [ ] Configure server to listen on PORT from env (default 3001)

- [ ] Integrate Socket.io with Express (AC: 2)
  - [ ] Install `socket.io` and `@types/socket.io`
  - [ ] Create Socket.io server attached to HTTP server
  - [ ] Configure CORS for Socket.io (allow localhost:3000)
  - [ ] Create `apps/api/src/socket/index.ts` for Socket.io setup
  - [ ] Add connection event handler
  - [ ] Log socket connections/disconnections

- [ ] Configure environment variables (AC: 4)
  - [ ] Create `apps/api/.env` file
  - [ ] Add PORT, NODE_ENV, DATABASE_URL, NEXTAUTH_SECRET
  - [ ] Create `apps/api/src/config/env.ts` to load and validate env vars
  - [ ] Export typed config object

- [ ] Set up core middleware (AC: 3, 8)
  - [ ] Configure CORS to allow http://localhost:3000 (development)
  - [ ] Add express.json() for JSON body parsing
  - [ ] Add express.urlencoded() for form data
  - [ ] Add morgan logger ('dev' format in development)
  - [ ] Add helmet for security headers (production)

- [ ] Create error handling middleware (AC: 6)
  - [ ] Create `apps/api/src/middleware/error.middleware.ts`
  - [ ] Define AppError class extending Error
  - [ ] Create global error handler middleware
  - [ ] Format errors as JSON with status, message, code
  - [ ] Log errors to console (will use Sentry in future)

- [ ] Create health check endpoint (AC: 5)
  - [ ] Create `apps/api/src/routes/health.routes.ts`
  - [ ] Define GET /api/health endpoint
  - [ ] Return { status: 'ok', timestamp, version }
  - [ ] Test database connection in health check (Prisma ping)

- [ ] Set up route structure (AC: 7)
  - [ ] Create `apps/api/src/routes/index.ts` as main router
  - [ ] Mount health routes at /api/health
  - [ ] Export router for use in server.ts
  - [ ] Add 404 handler for undefined routes

- [ ] Configure development workflow (AC: 7)
  - [ ] Add `dev` script using nodemon + tsx
  - [ ] Add `build` script using tsc
  - [ ] Add `start` script for production
  - [ ] Add `typecheck` script
  - [ ] Test hot reload works (nodemon)

- [ ] Create logging utility (AC: 3)
  - [ ] Install `pino` for structured logging
  - [ ] Create `apps/api/src/utils/logger.ts`
  - [ ] Configure logger with JSON format
  - [ ] Export logger instance for use across app

- [ ] Test server setup (AC: 1, 2, 5, 7, 8)
  - [ ] Start server with `pnpm dev`
  - [ ] Verify server listening on port 3001
  - [ ] Test health check: `curl http://localhost:3001/api/health`
  - [ ] Test CORS by making request from localhost:3000
  - [ ] Test Socket.io connection using Socket.io client
  - [ ] Verify hot reload on file changes

## Dev Notes

### Express.js Setup
**[Source: Architecture Section 3 - Tech Stack, Section 11 - Backend Architecture]**

**Framework:** Express.js **4.19+**
**Runtime:** Node.js **20 LTS**
**Language:** TypeScript **5.3+**

**Why Express.js:**
- Battle-tested, mature ecosystem
- Simple middleware architecture
- Works perfectly with Socket.io
- Excellent TypeScript support
- Lightweight for MVP

**`apps/api/src/server.ts` (COPY-PASTE READY):**
```typescript
import express from 'express';
import { createServer } from 'http';
import { Server as SocketIOServer } from 'socket.io';
import cors from 'cors';
import morgan from 'morgan';
import dotenv from 'dotenv';
import { router } from './routes';
import { errorMiddleware } from './middleware/error.middleware';
import { setupSocket } from './socket';
import { logger } from './utils/logger';

// Load environment variables
dotenv.config();

const app = express();
const httpServer = createServer(app);
const io = new SocketIOServer(httpServer, {
  cors: {
    origin: process.env.CORS_ORIGIN || 'http://localhost:3000',
    credentials: true,
  },
});

const PORT = process.env.PORT || 3001;

// Middleware
app.use(cors({
  origin: process.env.CORS_ORIGIN || 'http://localhost:3000',
  credentials: true,
}));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(morgan('dev'));

// Routes
app.use('/api', router);

// Socket.io setup
setupSocket(io);

// Error handling (must be last)
app.use(errorMiddleware);

// Start server
httpServer.listen(PORT, () => {
  logger.info(`ðŸš€ API server running on port ${PORT}`);
  logger.info(`ðŸ”Œ Socket.io server ready`);
});

export { app, io };
```

### Socket.io Configuration
**[Source: Architecture Section 3 - Tech Stack, Section 5.2 - WebSocket API]**

**Library:** Socket.io **4.7+**

**Why Socket.io:**
- Automatic reconnection
- Room/namespace support (for tables)
- Fallback to polling if WebSocket unavailable
- Built-in authentication support
- TypeScript-friendly

**`apps/api/src/socket/index.ts`:**
```typescript
import { Server as SocketIOServer } from 'socket.io';
import { logger } from '../utils/logger';

export function setupSocket(io: SocketIOServer) {
  io.on('connection', (socket) => {
    logger.info(`Socket connected: ${socket.id}`);

    socket.on('disconnect', () => {
      logger.info(`Socket disconnected: ${socket.id}`);
    });

    // Future stories will add event handlers here:
    // - join_table
    // - send_message
    // - roll_dice
    // - typing_start
    // - typing_stop
  });
}
```

### CORS Configuration
**[Source: Architecture Section 15.1 - Security]**

**Development:**
- Allow origin: `http://localhost:3000` (Next.js frontend)
- Credentials: `true` (for cookies)

**Production:**
- Allow origin: `https://iarpg.com`
- Credentials: `true`

**`apps/api/src/middleware/cors.config.ts`:**
```typescript
import { CorsOptions } from 'cors';

export const corsOptions: CorsOptions = {
  origin: process.env.CORS_ORIGIN || 'http://localhost:3000',
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
};
```

### Error Handling Middleware
**[Source: Architecture Section 18 - Error Handling Strategy]**

**`apps/api/src/middleware/error.middleware.ts`:**
```typescript
import { Request, Response, NextFunction } from 'express';
import { logger } from '../utils/logger';

export class AppError extends Error {
  constructor(
    public message: string,
    public statusCode: number = 500,
    public code: string = 'INTERNAL_ERROR',
    public details?: any
  ) {
    super(message);
    this.name = 'AppError';
  }
}

export const errorMiddleware = (
  error: Error,
  req: Request,
  res: Response,
  next: NextFunction
) => {
  logger.error('Error occurred:', {
    error: error.message,
    stack: error.stack,
    path: req.path,
    method: req.method,
  });

  if (error instanceof AppError) {
    return res.status(error.statusCode).json({
      error: {
        code: error.code,
        message: error.message,
        details: error.details,
        timestamp: new Date().toISOString(),
      },
    });
  }

  // Unknown error
  return res.status(500).json({
    error: {
      code: 'INTERNAL_ERROR',
      message: 'An unexpected error occurred',
      timestamp: new Date().toISOString(),
    },
  });
};
```

### Health Check Endpoint
**[Source: Best practices for API monitoring]**

**`apps/api/src/routes/health.routes.ts`:**
```typescript
import { Router } from 'express';
import { prisma } from '@iarpg/db';

const router = Router();

router.get('/', async (req, res) => {
  try {
    // Test database connection
    await prisma.$queryRaw`SELECT 1`;

    res.json({
      status: 'ok',
      timestamp: new Date().toISOString(),
      version: process.env.npm_package_version || '1.0.0',
      database: 'connected',
    });
  } catch (error) {
    res.status(503).json({
      status: 'error',
      timestamp: new Date().toISOString(),
      database: 'disconnected',
    });
  }
});

export default router;
```

### Main Router
**[Source: Architecture Section 11.1 - Backend Architecture]**

**`apps/api/src/routes/index.ts`:**
```typescript
import { Router } from 'express';
import healthRoutes from './health.routes';
// Future stories will import more routes:
// import authRoutes from './auth.routes';
// import charactersRoutes from './characters.routes';
// import tablesRoutes from './tables.routes';

const router = Router();

router.use('/health', healthRoutes);
// Future routes:
// router.use('/auth', authRoutes);
// router.use('/characters', authMiddleware, charactersRoutes);
// router.use('/tables', authMiddleware, tablesRoutes);

// 404 handler
router.use('*', (req, res) => {
  res.status(404).json({
    error: {
      code: 'NOT_FOUND',
      message: `Route ${req.method} ${req.originalUrl} not found`,
      timestamp: new Date().toISOString(),
    },
  });
});

export { router };
```

### Logging Utility
**[Source: Architecture Section 19 - Monitoring and Observability]**

**Library:** Pino **9+**

**`apps/api/src/utils/logger.ts`:**
```typescript
import pino from 'pino';

export const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  transport: {
    target: 'pino-pretty',
    options: {
      colorize: true,
      translateTime: 'SYS:standard',
      ignore: 'pid,hostname',
    },
  },
});
```

### Environment Configuration
**[Source: Architecture Section 14.2 - Deployment]**

**`apps/api/src/config/env.ts`:**
```typescript
import dotenv from 'dotenv';

dotenv.config();

export const env = {
  PORT: parseInt(process.env.PORT || '3001', 10),
  NODE_ENV: process.env.NODE_ENV || 'development',
  DATABASE_URL: process.env.DATABASE_URL!,
  NEXTAUTH_SECRET: process.env.NEXTAUTH_SECRET!,
  CORS_ORIGIN: process.env.CORS_ORIGIN || 'http://localhost:3000',
  LOG_LEVEL: process.env.LOG_LEVEL || 'info',
};

// Validate required env vars
const requiredEnvVars = ['DATABASE_URL', 'NEXTAUTH_SECRET'];
for (const envVar of requiredEnvVars) {
  if (!process.env[envVar]) {
    throw new Error(`Missing required environment variable: ${envVar}`);
  }
}
```

### Package.json Scripts
**[Source: Architecture Section 13 - Development Workflow]**

**`apps/api/package.json`:**
```json
{
  "name": "@iarpg/api",
  "version": "1.0.0",
  "scripts": {
    "dev": "nodemon --watch src --ext ts --exec tsx src/server.ts",
    "build": "tsc",
    "start": "node dist/server.js",
    "typecheck": "tsc --noEmit",
    "lint": "eslint src/**/*.ts",
    "test": "vitest"
  },
  "dependencies": {
    "express": "^4.19.0",
    "socket.io": "^4.7.0",
    "cors": "^2.8.5",
    "morgan": "^1.10.0",
    "dotenv": "^16.4.0",
    "pino": "^9.0.0",
    "pino-pretty": "^11.0.0",
    "@iarpg/db": "workspace:*",
    "@iarpg/shared": "workspace:*"
  },
  "devDependencies": {
    "@types/express": "^4.17.21",
    "@types/cors": "^2.8.17",
    "@types/morgan": "^1.9.9",
    "@types/node": "^20.0.0",
    "typescript": "^5.3.0",
    "tsx": "^4.7.0",
    "nodemon": "^3.0.0",
    "vitest": "^1.6.0"
  }
}
```

### TypeScript Configuration
**[Source: Architecture Section 17 - Coding Standards]**

**`apps/api/tsconfig.json`:**
```json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "node",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "types": ["node"]
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

### Environment Variables
**[Source: Architecture Section 14.2]**

**`apps/api/.env`:**
```bash
# Server
PORT=3001
NODE_ENV=development

# CORS
CORS_ORIGIN=http://localhost:3000

# Database (from Story 1.2)
DATABASE_URL="postgresql://..."

# Auth (from Story 1.3)
NEXTAUTH_SECRET="your-secret"

# Logging
LOG_LEVEL=info
```

### Testing

**Test Framework:** Vitest
**Test File Location:** `apps/api/tests/`

**Testing Standards:**
**[Source: Architecture Section 16 - Testing Strategy]**

**Sample test (health endpoint):**
```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import request from 'supertest';
import { app } from '../src/server';

describe('Health Endpoint', () => {
  it('should return 200 OK', async () => {
    const response = await request(app).get('/api/health');
    expect(response.status).toBe(200);
    expect(response.body.status).toBe('ok');
  });

  it('should check database connection', async () => {
    const response = await request(app).get('/api/health');
    expect(response.body.database).toBe('connected');
  });
});
```

**For this story:**
- Test server starts successfully
- Test health endpoint returns 200
- Test CORS headers are set correctly
- Test 404 handler for unknown routes
- Test error middleware formats errors

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
