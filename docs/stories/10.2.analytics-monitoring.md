# Story 10.2: Analytics & Monitoring

## Status
Draft

## Story
**As a** product owner,
**I want** analytics and monitoring dashboards,
**so that** I can track user behavior, system health, and business metrics.

## Acceptance Criteria
1. Google Analytics 4 (GA4) tracking on all pages
2. Custom events tracked: signup, login, character_created, table_joined, dice_rolled
3. Uptime monitoring with health check endpoint GET `/api/health`
4. System metrics dashboard: CPU, memory, response time, error rate
5. Business metrics: DAU, MAU, conversion rate (free â†’ premium)
6. Real-time user count displayed in admin panel
7. API response time tracking (P50, P95, P99)
8. Database connection pool monitoring

## Tasks / Subtasks

- [ ] Install Google Analytics (AC: 1)
  - [ ] Create GA4 property
  - [ ] Get measurement ID (G-XXXXXXXXXX)
  - [ ] Add gtag.js script to layout
  - [ ] Verify pageview tracking

- [ ] Implement custom event tracking (AC: 2)
  - [ ] Event: user_signup (params: method, tier)
  - [ ] Event: user_login (params: method)
  - [ ] Event: character_created (params: class, race, level)
  - [ ] Event: table_joined (params: tableId, playStyle)
  - [ ] Event: dice_rolled (params: notation, result)
  - [ ] Event: subscription_started (params: tier, trial)

- [ ] Create analytics utility (AC: 2)
  - [ ] Function `trackEvent(eventName, params)`
  - [ ] Wrapper for gtag calls
  - [ ] TypeScript types for events
  - [ ] Disable in development

- [ ] Create health check endpoint (AC: 3)
  - [ ] GET `/api/health`
  - [ ] Check database connection
  - [ ] Check Redis connection (if applicable)
  - [ ] Return status: healthy/unhealthy
  - [ ] Include uptime, version

- [ ] Implement system metrics (AC: 4)
  - [ ] Collect CPU usage
  - [ ] Collect memory usage
  - [ ] Collect active connections
  - [ ] Collect event loop lag
  - [ ] Expose metrics endpoint for Prometheus (optional)

- [ ] Create metrics dashboard (AC: 4, 5)
  - [ ] Admin page: `/admin/metrics`
  - [ ] Charts: Response time, error rate, users
  - [ ] Business metrics: DAU, MAU, conversion rate
  - [ ] Real-time updates (every 30s)

- [ ] Track real-time user count (AC: 6)
  - [ ] Use Socket.io connection tracking
  - [ ] Store active users in Redis/memory
  - [ ] Display count in admin panel
  - [ ] Update every 10 seconds

- [ ] Implement response time tracking (AC: 7)
  - [ ] Middleware records request duration
  - [ ] Calculate P50, P95, P99 percentiles
  - [ ] Store in time-series database or aggregates
  - [ ] Display in metrics dashboard

- [ ] Monitor database connection pool (AC: 8)
  - [ ] Prisma connection pool metrics
  - [ ] Active connections, idle connections
  - [ ] Query duration tracking
  - [ ] Display in admin panel

- [ ] Calculate business metrics (AC: 5)
  - [ ] DAU: distinct users per day
  - [ ] MAU: distinct users per 30 days
  - [ ] Conversion rate: premium/total signups
  - [ ] Churn rate: canceled/active subscriptions
  - [ ] ARPU: average revenue per user

- [ ] Set up uptime monitoring (AC: 3)
  - [ ] Use UptimeRobot or similar (external)
  - [ ] Monitor `/api/health` endpoint
  - [ ] Alert on downtime (email/SMS)
  - [ ] Configure check interval: 5 minutes

- [ ] Add performance monitoring (AC: 4, 7)
  - [ ] Track API endpoint performance
  - [ ] Track slow queries (>1s)
  - [ ] Track high error rates (>5%)
  - [ ] Log performance warnings

- [ ] Create analytics admin page (AC: 2, 5, 6)
  - [ ] Page: `/admin/analytics`
  - [ ] User activity charts
  - [ ] Feature usage stats
  - [ ] Conversion funnel
  - [ ] Top tables, characters, users

## Dev Notes

### Google Analytics 4 Setup
**[Source: GA4 Next.js integration]**

```bash
pnpm add @next/third-parties
```

```tsx
// apps/web/src/app/layout.tsx
import { GoogleAnalytics } from '@next/third-parties/google';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body>
        {children}
        <GoogleAnalytics gaId={process.env.NEXT_PUBLIC_GA_ID!} />
      </body>
    </html>
  );
}
```

**Environment variable:**
```bash
NEXT_PUBLIC_GA_ID=G-XXXXXXXXXX
```

### Analytics Utility
```typescript
// apps/web/src/lib/analytics.ts
type EventParams = {
  [key: string]: any;
};

declare global {
  interface Window {
    gtag?: (
      command: 'event',
      eventName: string,
      params: EventParams
    ) => void;
  }
}

export function trackEvent(eventName: string, params?: EventParams) {
  if (process.env.NODE_ENV === 'development') {
    console.log('Analytics Event:', eventName, params);
    return;
  }

  if (typeof window !== 'undefined' && window.gtag) {
    window.gtag('event', eventName, params || {});
  }
}

// Predefined events
export const analytics = {
  userSignup(method: string, tier: string) {
    trackEvent('user_signup', { method, tier });
  },

  userLogin(method: string) {
    trackEvent('user_login', { method });
  },

  characterCreated(characterClass: string, race: string, level: number) {
    trackEvent('character_created', {
      class: characterClass,
      race,
      level,
    });
  },

  tableJoined(tableId: string, playStyle: string) {
    trackEvent('table_joined', { table_id: tableId, play_style: playStyle });
  },

  diceRolled(notation: string, result: number) {
    trackEvent('dice_rolled', { notation, result });
  },

  subscriptionStarted(tier: string, trial: boolean) {
    trackEvent('subscription_started', { tier, trial });
  },
};
```

**Usage:**
```typescript
import { analytics } from '@/lib/analytics';

// After signup
analytics.userSignup('email', 'free');

// After character creation
analytics.characterCreated('Fighter', 'Human', 1);
```

### Health Check Endpoint
**[Source: Express health check pattern]**

```typescript
// apps/api/src/controllers/health.controller.ts
import { Request, Response } from 'express';
import { prisma } from '@iarpg/db';

let startTime = Date.now();

export const healthController = {
  async check(req: Request, res: Response) {
    const healthStatus: any = {
      status: 'healthy',
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
      version: process.env.npm_package_version || '1.0.0',
    };

    try {
      // Check database connection
      await prisma.$queryRaw`SELECT 1`;
      healthStatus.database = 'connected';
    } catch (error) {
      healthStatus.status = 'unhealthy';
      healthStatus.database = 'disconnected';
      healthStatus.error = (error as Error).message;
    }

    // Memory usage
    const memUsage = process.memoryUsage();
    healthStatus.memory = {
      rss: `${(memUsage.rss / 1024 / 1024).toFixed(2)} MB`,
      heapUsed: `${(memUsage.heapUsed / 1024 / 1024).toFixed(2)} MB`,
    };

    const statusCode = healthStatus.status === 'healthy' ? 200 : 503;
    res.status(statusCode).json(healthStatus);
  },
};
```

**Route:**
```typescript
// apps/api/src/routes/health.routes.ts
import express from 'express';
import { healthController } from '../controllers/health.controller';

const router = express.Router();

router.get('/', healthController.check);

export default router;
```

### System Metrics Collection
```bash
pnpm add prom-client
```

```typescript
// apps/api/src/lib/metrics.ts
import client from 'prom-client';

// Create registry
export const register = new client.Registry();

// Default metrics (CPU, memory)
client.collectDefaultMetrics({ register });

// Custom metrics
export const httpRequestDuration = new client.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status_code'],
  buckets: [0.1, 0.3, 0.5, 0.7, 1, 3, 5, 7, 10],
});

export const httpRequestTotal = new client.Counter({
  name: 'http_requests_total',
  help: 'Total number of HTTP requests',
  labelNames: ['method', 'route', 'status_code'],
});

export const activeConnections = new client.Gauge({
  name: 'active_connections',
  help: 'Number of active WebSocket connections',
});

register.registerMetric(httpRequestDuration);
register.registerMetric(httpRequestTotal);
register.registerMetric(activeConnections);
```

**Metrics middleware:**
```typescript
// apps/api/src/middleware/metrics.ts
import { Request, Response, NextFunction } from 'express';
import { httpRequestDuration, httpRequestTotal } from '../lib/metrics';

export function metricsMiddleware(req: Request, res: Response, next: NextFunction) {
  const start = Date.now();

  res.on('finish', () => {
    const duration = (Date.now() - start) / 1000;

    httpRequestDuration.observe(
      {
        method: req.method,
        route: req.route?.path || req.path,
        status_code: res.statusCode,
      },
      duration
    );

    httpRequestTotal.inc({
      method: req.method,
      route: req.route?.path || req.path,
      status_code: res.statusCode,
    });
  });

  next();
}
```

**Metrics endpoint:**
```typescript
// apps/api/src/routes/metrics.routes.ts
import express from 'express';
import { register } from '../lib/metrics';

const router = express.Router();

router.get('/', async (req, res) => {
  res.set('Content-Type', register.contentType);
  res.end(await register.metrics());
});

export default router;
```

### Metrics Dashboard
```typescript
// apps/web/src/app/admin/metrics/page.tsx
'use client';

import { useEffect, useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Line } from 'react-chartjs-2';

interface Metrics {
  responseTime: { p50: number; p95: number; p99: number };
  errorRate: number;
  activeUsers: number;
  dau: number;
  mau: number;
  conversionRate: number;
}

export default function MetricsPage() {
  const [metrics, setMetrics] = useState<Metrics | null>(null);

  useEffect(() => {
    fetchMetrics();

    const interval = setInterval(fetchMetrics, 30000); // Update every 30s
    return () => clearInterval(interval);
  }, []);

  const fetchMetrics = async () => {
    const response = await fetch('/api/admin/metrics');
    const data = await response.json();
    setMetrics(data);
  };

  if (!metrics) return <div>Loading...</div>;

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-6">System Metrics</h1>

      {/* KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <Card>
          <CardHeader>
            <CardTitle className="text-sm text-gray-400">Active Users</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-3xl font-bold">{metrics.activeUsers}</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="text-sm text-gray-400">DAU</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-3xl font-bold">{metrics.dau}</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="text-sm text-gray-400">MAU</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-3xl font-bold">{metrics.mau}</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="text-sm text-gray-400">Conversion Rate</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-3xl font-bold">{(metrics.conversionRate * 100).toFixed(1)}%</p>
          </CardContent>
        </Card>
      </div>

      {/* Response Time */}
      <Card className="mb-8">
        <CardHeader>
          <CardTitle>Response Time</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-3 gap-4">
            <div>
              <p className="text-sm text-gray-400">P50</p>
              <p className="text-2xl font-bold">{metrics.responseTime.p50}ms</p>
            </div>
            <div>
              <p className="text-sm text-gray-400">P95</p>
              <p className="text-2xl font-bold">{metrics.responseTime.p95}ms</p>
            </div>
            <div>
              <p className="text-sm text-gray-400">P99</p>
              <p className="text-2xl font-bold">{metrics.responseTime.p99}ms</p>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Error Rate */}
      <Card>
        <CardHeader>
          <CardTitle>Error Rate</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-3xl font-bold text-red-500">{(metrics.errorRate * 100).toFixed(2)}%</p>
        </CardContent>
      </Card>
    </div>
  );
}
```

### Business Metrics API
```typescript
// apps/api/src/controllers/adminMetrics.controller.ts
import { Request, Response, NextFunction } from 'express';
import { prisma } from '@iarpg/db';

export const adminMetricsController = {
  async getMetrics(req: Request, res: Response, next: NextFunction) {
    try {
      const now = new Date();
      const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
      const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

      // DAU (Daily Active Users)
      const dau = await prisma.user.count({
        where: {
          updatedAt: { gte: oneDayAgo },
        },
      });

      // MAU (Monthly Active Users)
      const mau = await prisma.user.count({
        where: {
          updatedAt: { gte: thirtyDaysAgo },
        },
      });

      // Total users
      const totalUsers = await prisma.user.count();

      // Premium users
      const premiumUsers = await prisma.user.count({
        where: {
          tier: { in: ['premium', 'master'] },
          subscriptionStatus: 'active',
        },
      });

      // Conversion rate
      const conversionRate = totalUsers > 0 ? premiumUsers / totalUsers : 0;

      // Active WebSocket connections (from global state or Redis)
      const activeUsers = global.activeConnections || 0;

      // Response time (mock - integrate with metrics)
      const responseTime = {
        p50: 120,
        p95: 350,
        p99: 800,
      };

      // Error rate (mock - calculate from logs)
      const errorRate = 0.02; // 2%

      res.json({
        activeUsers,
        dau,
        mau,
        totalUsers,
        premiumUsers,
        conversionRate,
        responseTime,
        errorRate,
      });
    } catch (error) {
      next(error);
    }
  },
};
```

### Real-time User Tracking
```typescript
// apps/api/src/lib/activeUsers.ts
const activeUsers = new Set<string>();

export function addActiveUser(userId: string) {
  activeUsers.add(userId);
}

export function removeActiveUser(userId: string) {
  activeUsers.delete(userId);
}

export function getActiveUserCount(): number {
  return activeUsers.size;
}

// Store globally
(global as any).activeConnections = 0;

export function updateActiveConnections(count: number) {
  (global as any).activeConnections = count;
}
```

**Socket.io integration:**
```typescript
// apps/api/src/socket.ts (updated)
import { addActiveUser, removeActiveUser, updateActiveConnections, getActiveUserCount } from './lib/activeUsers';

io.on('connection', (socket) => {
  const userId = socket.handshake.auth.userId;

  if (userId) {
    addActiveUser(userId);
    updateActiveConnections(getActiveUserCount());
  }

  socket.on('disconnect', () => {
    if (userId) {
      removeActiveUser(userId);
      updateActiveConnections(getActiveUserCount());
    }
  });
});
```

### Uptime Monitoring Setup
**[Source: UptimeRobot configuration]**

1. Sign up at uptimerobot.com
2. Create monitor:
   - Type: HTTP(s)
   - URL: `https://yourdomain.com/api/health`
   - Interval: 5 minutes
3. Configure alerts:
   - Email notification on down
   - SMS notification (optional)
4. Add status page (public/private)

### Environment Variables
```bash
# .env.local (frontend)
NEXT_PUBLIC_GA_ID=G-XXXXXXXXXX

# .env (backend)
# No additional variables needed for basic metrics
```

### Testing

**Test scenarios:**
- Google Analytics tracks pageviews
- Custom events tracked (signup, login, etc.)
- Health check endpoint returns 200 when healthy
- Health check returns 503 when database down
- Metrics endpoint returns Prometheus format
- Metrics dashboard displays real-time data
- DAU/MAU calculated correctly
- Conversion rate calculated correctly
- Response time percentiles accurate
- Active user count updates in real-time
- UptimeRobot receives health check responses
- Error rate calculation includes failed requests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
