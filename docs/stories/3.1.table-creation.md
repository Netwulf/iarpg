# Story 3.1: Table Creation

## Status
Draft

## Story
**As a** User,
**I want** to create RPG tables with customizable settings (name, play style, privacy, schedule),
**so that** I can set up a game that matches how I want to play (sync/async/solo).

## Acceptance Criteria
1. Table creation page is accessible at `/tables/new`
2. Form includes: name, description, play style (sync/async/solo), privacy (private/public/spectator)
3. Form includes: max players (2-8), schedule (optional text), tags (optional)
4. System generates unique invite code automatically (6-character alphanumeric)
5. Table is saved to database with creator as owner and state "setup"
6. After creation, user is redirected to table page `/tables/{id}`
7. Creator is automatically added as first table member with DM role
8. Validation prevents duplicate table names for same user

## Tasks / Subtasks

- [ ] Create table creation page (AC: 1)
  - [ ] Create `/tables/new` route
  - [ ] Add "Create Table" button on dashboard
  - [ ] Create TableCreateForm component
  - [ ] Add page heading and description

- [ ] Build table creation form (AC: 2, 3)
  - [ ] Add name input (required, max 50 chars)
  - [ ] Add description textarea (optional, max 500 chars)
  - [ ] Add play style radio group: Sync, Async, Solo
  - [ ] Add privacy radio group: Private, Public, Spectator
  - [ ] Add max players number input (2-8, default 6)
  - [ ] Add schedule input (optional text, e.g., "Tuesdays 8pm EST")
  - [ ] Add tags input (comma-separated, optional)
  - [ ] Add "Create Table" submit button

- [ ] Implement play style selection (AC: 2)
  - [ ] **Sync:** Live text sessions with realtime chat
  - [ ] **Async:** Play-by-post, flexible timing
  - [ ] **Solo:** AI DM mode, single player
  - [ ] Display description for each mode on hover/selection

- [ ] Implement privacy level selection (AC: 2)
  - [ ] **Private:** Invite-only, hidden from discovery
  - [ ] **Public:** Visible in browse, anyone can join
  - [ ] **Spectator:** Public + allows non-player viewers
  - [ ] Display description for each level

- [ ] Generate invite code (AC: 4)
  - [ ] Create utility function to generate 6-char code
  - [ ] Use alphanumeric characters (A-Z, 0-9, case-insensitive)
  - [ ] Ensure uniqueness (check database, retry if duplicate)
  - [ ] Format: ABC123 (all caps for readability)

- [ ] Create table API endpoint (AC: 5, 7)
  - [ ] POST `/api/tables` endpoint
  - [ ] Validate required fields (name, playStyle, privacy)
  - [ ] Generate invite code
  - [ ] Create table with state "setup"
  - [ ] Create TableMember record with creator as DM
  - [ ] Return created table with ID

- [ ] Validate table name uniqueness (AC: 8)
  - [ ] Check if user already has table with same name
  - [ ] Return validation error if duplicate
  - [ ] Allow same name if previous table is completed/archived

- [ ] Handle form submission (AC: 6)
  - [ ] Show loading state during creation
  - [ ] Handle validation errors (display inline)
  - [ ] On success: redirect to `/tables/{id}`
  - [ ] Show success toast: "Table created! Share invite code: {code}"

- [ ] Add form validation (AC: 2, 3, 8)
  - [ ] Name: required, 3-50 characters
  - [ ] Description: max 500 characters
  - [ ] Play style: required, one of [sync, async, solo]
  - [ ] Privacy: required, one of [private, public, spectator]
  - [ ] Max players: 2-8
  - [ ] Tags: max 5 tags, each max 20 chars

- [ ] Style table creation form (AC: 1-3)
  - [ ] Use shadcn/ui form components
  - [ ] Group related fields (basic info, settings, advanced)
  - [ ] Use Radio Group for play style/privacy
  - [ ] Show character count for name/description
  - [ ] Use green-neon accent for selected options

## Dev Notes

### Table Data Model
**[Source: Architecture Section 4.3 - Table Model]**

```typescript
interface Table {
  id: string;
  ownerId: string;
  name: string;
  description: string;
  playStyle: 'sync' | 'async' | 'solo';
  privacy: 'private' | 'public' | 'spectator';
  inviteCode: string;
  state: 'setup' | 'active' | 'paused' | 'completed';
  schedule?: string;
  maxPlayers: number; // Default 6
  tags: string[];
  rulesVariant: 'standard' | 'homebrew'; // Default 'standard'
  thumbnailUrl?: string;
  createdAt: Date;
  updatedAt: Date;
  lastActivityAt: Date;
}
```

### Invite Code Generation
**[Source: Best practices for invite codes]**

```typescript
function generateInviteCode(): string {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // No confusing chars (0, O, I, 1)
  let code = '';
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

async function generateUniqueInviteCode(): Promise<string> {
  let code = generateInviteCode();
  let exists = await prisma.table.findUnique({ where: { inviteCode: code } });

  while (exists) {
    code = generateInviteCode();
    exists = await prisma.table.findUnique({ where: { inviteCode: code } });
  }

  return code;
}
```

### API Endpoint
**[Source: Architecture Section 5.1.4 - Table Endpoints]**

```typescript
POST /api/tables

Request:
{
  name: "Lost Mines of Phandelver",
  description: "Classic D&D 5e starter adventure",
  playStyle: "async",
  privacy: "public",
  maxPlayers: 6,
  schedule: "Weekdays, flexible",
  tags: ["beginner-friendly", "5e", "official-adventure"]
}

Response 201:
{
  table: {
    id: "clxxx",
    ownerId: "clyyyy",
    name: "Lost Mines of Phandelver",
    description: "Classic D&D 5e starter adventure",
    playStyle: "async",
    privacy: "public",
    inviteCode: "ABC123",
    state: "setup",
    maxPlayers: 6,
    schedule: "Weekdays, flexible",
    tags: ["beginner-friendly", "5e", "official-adventure"],
    createdAt: "2025-09-30T...",
    // ... other fields
  }
}
```

### Play Style Descriptions
**[Source: PRD FR9 - Table Management]**

- **Sync:** Real-time text sessions. Players meet at scheduled time, chat live with typing indicators. Best for traditional session feel.
- **Async:** Play-by-post format. Players post when available (within turn deadlines). Ideal for busy schedules.
- **Solo:** Single-player mode with AI as DM. Play at your own pace, no coordination needed.

### Privacy Level Descriptions
**[Source: PRD FR10 - Privacy Levels]**

- **Private:** Invite-only. Hidden from public discovery. Only invited players can join.
- **Public:** Listed in table browser. Anyone can request to join (DM approves).
- **Spectator:** Public table that also allows viewers (non-players can watch game).

### Form Component Example
```typescript
function TableCreateForm() {
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    playStyle: 'async' as PlayStyle,
    privacy: 'private' as Privacy,
    maxPlayers: 6,
    schedule: '',
    tags: '',
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    const tagsArray = formData.tags
      .split(',')
      .map(t => t.trim())
      .filter(t => t.length > 0);

    const response = await apiClient.post('/api/tables', {
      ...formData,
      tags: tagsArray,
    });

    router.push(`/tables/${response.data.table.id}`);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <Input
        label="Table Name"
        value={formData.name}
        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
        required
        maxLength={50}
      />

      <Textarea
        label="Description"
        value={formData.description}
        onChange={(e) => setFormData({ ...formData, description: e.target.value })}
        maxLength={500}
      />

      <RadioGroup
        label="Play Style"
        value={formData.playStyle}
        onValueChange={(value) => setFormData({ ...formData, playStyle: value })}
      >
        <RadioGroupItem value="sync">Sync (Live Sessions)</RadioGroupItem>
        <RadioGroupItem value="async">Async (Play-by-Post)</RadioGroupItem>
        <RadioGroupItem value="solo">Solo (AI DM)</RadioGroupItem>
      </RadioGroup>

      {/* ... more fields */}

      <Button type="submit">Create Table</Button>
    </form>
  );
}
```

### Backend Controller
```typescript
// apps/api/src/controllers/tables.controller.ts
export const tablesController = {
  async create(req: Request, res: Response, next: NextFunction) {
    try {
      const userId = req.user!.id;
      const { name, description, playStyle, privacy, maxPlayers, schedule, tags } = req.body;

      // Validate uniqueness
      const existing = await prisma.table.findFirst({
        where: {
          ownerId: userId,
          name,
          state: { in: ['setup', 'active', 'paused'] }
        }
      });

      if (existing) {
        return res.status(400).json({ error: 'You already have a table with this name' });
      }

      // Generate invite code
      const inviteCode = await generateUniqueInviteCode();

      // Create table
      const table = await prisma.table.create({
        data: {
          ownerId: userId,
          name,
          description,
          playStyle,
          privacy,
          inviteCode,
          maxPlayers: maxPlayers || 6,
          schedule,
          tags: tags || [],
          state: 'setup',
        },
      });

      // Add creator as DM
      await prisma.tableMember.create({
        data: {
          tableId: table.id,
          userId,
          characterId: null, // DM doesn't need character
          role: 'dm',
          status: 'active',
        },
      });

      res.status(201).json({ table });
    } catch (error) {
      next(error);
    }
  },
};
```

### Testing

**Test scenarios:**
- Form validates required fields
- Invite code is generated and unique
- Table is created with correct data
- Creator is added as DM
- Duplicate table name for same user is rejected
- Different users can have tables with same name
- Redirect to table page after creation
- Tags are parsed correctly from comma-separated input

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
